<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>母婴客户管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/v4-shims.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#7c3aed',
                        accent: '#f59e0b',
                        success: '#059669',
                        danger: '#dc2626',
                        warning: '#d97706',
                        info: '#0891b2',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(147, 197, 253, 0.3) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(251, 191, 36, 0.3) 0%, transparent 20%);
            min-height: 100vh;
        }
        
        /* 动画效果已优化 */
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        .badge {
            position: relative;
            overflow: hidden;
        }
        
        .badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .badge:hover::before {
            left: 100%;
        }
        
        .btn-hover {
            position: relative;
            overflow: hidden;
        }
        
        /* 按钮动画效果已移除 */
    </style>
</head>
<body class="min-h-screen">
    <!-- 调试面板 -->
    <!-- <div id="debug-panel" class="fixed bottom-4 right-4 bg-black text-white p-4 rounded-lg max-w-md max-h-60 overflow-y-auto z-99999">
            <h4 class="font-bold mb-2">调试信息</h4>
            <div id="debug-log"></div>
        </div> -->
    <!-- 顶部导航 -->
    <nav class="bg-white shadow-lg border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-2 rounded-lg">
                        <i class="fa fa-heart text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">母婴客户管理系统</h1>
                        <p class="text-xs text-gray-500">专业客户管理 · 智能用量计算 · 自动回访提醒</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showStatistics()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-bar-chart mr-2"></i>统计
                    </button>
                    <button onclick="showSettings()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-cog mr-2"></i>设置
                    </button>
                    <button onclick="showDataManagement()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-database mr-2"></i>数据管理
                    </button>
                    <button onclick="showMergeCustomers()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-users mr-2"></i>合并客户
                    </button>
                    <button onclick="showHelp()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-question-circle mr-2"></i>帮助
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 数据概览卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-lg hover-scale card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">总客户数</p>
                        <p id="total-customers" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fa fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg hover-scale card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">今日提醒</p>
                        <p id="today-reminders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fa fa-bell text-orange-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg hover-scale card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">宝宝总数</p>
                        <p id="total-babies" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-pink-100 p-3 rounded-full">
                        <i class="fa fa-child text-pink-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg hover-scale card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">营养品客户</p>
                        <p id="nutrition-customers" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fa fa-bullseye text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg hover-scale card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">当月预产期</p>
                        <p id="due-date-customers" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fa fa-calendar text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg hover-scale card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">待回访客户</p>
                        <p id="follow-up-customers" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fa fa-phone text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快捷操作按钮 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <button onclick="showAddCustomerModal()" class="bg-blue-500 text-white p-8 rounded-xl hover:bg-blue-600 transition-all duration-300 hover-scale btn-hover">
                <div class="text-center">
                    <i class="fa fa-plus-circle text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">添加客户</h3>
                    <p class="text-blue-100">快速创建新客户档案</p>
                </div>
            </button>
            <button onclick="showAddProductModal()" class="bg-green-500 text-white p-8 rounded-xl hover:bg-green-600 transition-all duration-300 hover-scale btn-hover">
                <div class="text-center">
                    <i class="fa fa-shopping-cart text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">添加产品</h3>
                    <p class="text-green-100">为客户添加产品使用记录</p>
                </div>
            </button>
            <button onclick="showStorageManagement()" class="bg-pink-500 text-white p-8 rounded-xl hover:bg-pink-600 transition-all duration-300 hover-scale btn-hover">
                <div class="text-center">
                    <i class="fa fa-archive text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">寄存管理</h3>
                    <p class="text-pink-100">管理客户产品寄存记录</p>
                </div>
            </button>
        </div>

        <!-- 提醒和客户管理区域 -->
        <div class="grid grid-cols-1 gap-8">
            <!-- 今日提醒 -->
            <div class="space-y-8">
                <div class="bg-white rounded-xl shadow-lg p-6 card-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fa fa-bell text-orange-500 mr-3"></i>今日提醒
                        </h2>
                        <div class="flex space-x-3">
                            <select id="reminder-filter" onchange="filterReminders()" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                <option value="all">全部提醒</option>
                                <option value="pending">未完成</option>
                                <option value="completed">已完成</option>
                            </select>
                        </div>
                    </div>
                    <div id="today-reminders-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- 提醒内容将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 历史提醒、当月预产期、预计可用时间 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- 历史提醒 -->
                <div class="space-y-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-900 flex items-center">
                                <i class="fa fa-clock-o text-gray-500 mr-3"></i>历史提醒
                            </h2>
                        </div>
                        <div id="historical-reminders-list" class="space-y-4 max-h-80 overflow-y-auto">
                            <!-- 历史提醒内容将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
                <!-- 当月预产期 -->
                <div class="space-y-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-shadow">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-900 flex items-center">
                                <i class="fa fa-calendar text-purple-500 mr-3"></i>当月预产期 <span id="current-month" class="text-sm text-gray-500 ml-2"></span>
                            </h2>
                        </div>
                        <div id="due-date-list" class="space-y-4 max-h-80 overflow-y-auto">
                            <!-- 预产期内容将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 预计可用时间 -->
                <div class="space-y-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-shadow">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-900 flex items-center">
                                <i class="fa fa-clock-o text-blue-500 mr-3"></i>预计可用时间
                            </h2>
                        </div>
                        <div id="product-usage-list" class="space-y-4 max-h-80 overflow-y-auto">
                            <!-- 产品使用时间内容将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 客户管理区域 -->
        <div class="mt-8">
            <div class="bg-white rounded-xl shadow-lg p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fa fa-users text-green-500 mr-3"></i>客户管理
                    </h2>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="search-customer" placeholder="搜索客户..." class="w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <select id="status-filter" onchange="filterCustomers()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="all">所有状态</option>
                            <option value="正常">正常</option>
                            <option value="孕妇">孕妇</option>
                            <option value="新客户">新客户</option>
                            <option value="VIP">VIP</option>
                            <option value="暂停服务">暂停服务</option>
                        </select>
                        <select id="owner-filter" onchange="filterCustomers()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="all">所有归属人</option>
                        </select>
                        <button onclick="showAddCustomerModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fa fa-plus mr-2"></i>添加客户
                        </button>
                    </div>
                </div>
                <div id="customers-list" class="space-y-4 max-h-[calc(100vh-30rem)] overflow-y-auto">
                    <!-- 客户列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 添加客户模态框 -->
    <div id="add-customer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">添加客户信息</h3>
                    <button onclick="closeModal('add-customer-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="add-customer-form" onsubmit="saveCustomer(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">客户姓名 *</label>
                            <input type="text" id="new-customer-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">联系电话 *</label>
                            <input type="tel" id="new-customer-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">微信号</label>
                            <input type="text" id="new-customer-wechat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">客户身份</label>
                            <input type="text" id="new-customer-identity" placeholder="例如：宝妈、宝爸、奶奶" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">归属人 *</label>
                            <input type="text" id="new-customer-owner" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">预产期</label>
                            <input type="month" id="new-customer-due-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">客户状态 *</label>
                            <select id="new-customer-status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="正常">正常</option>
                                <option value="孕妇">孕妇</option>
                                <option value="新客户">新客户</option>
                                <option value="VIP">VIP</option>
                                <option value="暂停服务">暂停服务</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">是否过敏体质 *</label>
                            <select id="new-customer-allergic" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" onchange="toggleAllergyInfo()">
                                <option value="否">否</option>
                                <option value="是">是</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="allergy-info-container" class="mb-6 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">过敏信息</label>
                        <input type="text" id="new-customer-allergy-info" placeholder="请详细描述过敏情况" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <!-- 宝宝信息 -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">宝宝信息</h4>
                        <div id="babies-container">
                            <div class="baby-form grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 border border-dashed border-gray-300 rounded-lg">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">宝宝姓名 *</label>
                                    <input type="text" class="baby-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">出生日期</label>
                                    <input type="date" class="baby-birthdate w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">或通过年龄计算</label>
                                    <div class="flex space-x-3">
                                        <input type="number" class="baby-age-years w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="岁">
                                        <input type="number" class="baby-age-months w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="月">
                                        <button type="button" onclick="calculateBirthdate(this)" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                            <i class="fa fa-calculator"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">性别</label>
                                    <select class="baby-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">请选择</option>
                                        <option value="男">男</option>
                                        <option value="女">女</option>
                                    </select>
                                </div>
                                <div class="md:col-span-5">
                                    <button type="button" onclick="removeBabyForm(this)" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                        <i class="fa fa-trash mr-2"></i>删除
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addBabyForm()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fa fa-plus mr-2"></i>添加宝宝信息
                        </button>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeModal('add-customer-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            保存客户信息
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑客户模态框 -->
    <div id="edit-customer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[10000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">编辑客户信息</h3>
                    <button onclick="closeModal('edit-customer-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="edit-customer-form" onsubmit="updateCustomer(event)">
                    <input type="hidden" id="edit-customer-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">客户姓名 *</label>
                            <input type="text" id="edit-customer-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">联系电话 *</label>
                            <input type="tel" id="edit-customer-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">微信号</label>
                            <input type="text" id="edit-customer-wechat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">客户身份</label>
                            <input type="text" id="edit-customer-identity" placeholder="例如：宝妈、宝爸、奶奶" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">归属人 *</label>
                            <input type="text" id="edit-customer-owner" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">预产期</label>
                            <input type="month" id="edit-customer-due-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">客户状态 *</label>
                            <select id="edit-customer-status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="正常">正常</option>
                                <option value="孕妇">孕妇</option>
                                <option value="新客户">新客户</option>
                                <option value="VIP">VIP</option>
                                <option value="暂停服务">暂停服务</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">是否过敏体质 *</label>
                            <select id="edit-customer-allergic" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" onchange="toggleEditAllergyInfo()">
                                <option value="否">否</option>
                                <option value="是">是</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="edit-allergy-info-container" class="mb-6 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">过敏信息</label>
                        <input type="text" id="edit-customer-allergy-info" placeholder="请详细描述过敏情况" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <!-- 宝宝信息 -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">宝宝信息</h4>
                        <div id="edit-babies-container">
                            <!-- 宝宝信息将通过JavaScript动态生成 -->
                        </div>
                        <button type="button" onclick="addEditBabyForm()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fa fa-plus mr-2"></i>添加宝宝信息
                        </button>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeModal('edit-customer-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            更新客户信息
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 客户详情模态框 -->
    <div id="customer-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[10000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 id="customer-detail-title" class="text-xl font-bold text-gray-900">客户详情</h3>
                    <div class="flex space-x-2">
                        <button onclick="closeModal('customer-detail-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-8">
                <div id="customer-detail-content">
                    <!-- 客户详情内容 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 添加产品模态框 -->
    <div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[10001] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">添加产品记录</h3>
                    <button onclick="closeModal('add-product-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-8">
                <form id="add-product-form">
                    <input type="hidden" id="product-customer-id">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">选择客户 *</label>
                        <select id="product-customer-select" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" onchange="loadCustomerProducts()">
                            <option value="">请选择客户</option>
                        </select>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">产品类型 *</label>
                        <select id="product-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" onchange="showProductForm()">
                            <option value="">请选择产品类型</option>
                            <option value="milk">奶粉</option>
                            <option value="diaper">尿不湿</option>
                            <option value="nutrition">营养品</option>
                        </select>
                    </div>

                    <!-- 奶粉表单 -->
                    <div id="milk-form" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">品名 *</label>
                                <input type="text" id="new-milk-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">品牌 *</label>
                                <input type="text" id="new-milk-brand" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">每罐重量(克) *</label>
                                <input type="number" id="new-milk-weight" required min="0.1" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">每勺奶粉重量(克) *</label>
                                <input type="number" id="new-milk-spoon-weight" required min="0.1" step="0.1" value="4.3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">每勺添加水量(毫升) *</label>
                                <input type="number" id="new-milk-water" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">单价(元)</label>
                                <input type="number" id="new-milk-price" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateMilkTotalPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">总价(元)</label>
                                <input type="number" id="new-milk-total-price" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateMilkPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">购买数量(罐) *</label>
                                <input type="number" id="new-milk-purchase-quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate(); calculateMilkTotalPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">拿走数量(罐) *</label>
                                <input type="number" id="new-milk-take-quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="new-milk-storage" class="mr-2" onchange="toggleStorageQuantity('milk')">
                                    <label class="block text-sm font-medium text-gray-700">需要寄存</label>
                                </div>
                                <div id="new-milk-storage-quantity-container" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">寄存数量(罐)</label>
                                    <input type="number" id="new-milk-storage-quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">每日奶量(毫升) *</label>
                                <input type="number" id="new-milk-daily-grams" required min="0.1" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">取货日期 *</label>
                                <input type="date" id="new-milk-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" onchange="calculateEndDate()">
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex items-center space-x-2 mb-2">
                                    <label class="block text-sm font-medium text-gray-700">预计用完日期</label>
                                    <button type="button" onclick="calculateEndDate()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                        <i class="fa fa-calculator mr-1"></i>重新计算
                                    </button>
                                </div>
                                <input type="date" id="new-milk-end-date" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                            </div>
                        </div>
                    </div>

                    <!-- 尿不湿表单 -->
                    <div id="diaper-form" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">品名 *</label>
                                <input type="text" id="new-diaper-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">规格(用户自定义) *</label>
                                <input type="text" id="new-diaper-size" required placeholder="例如：S、M、L、XL或自定义描述" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">单价(元)</label>
                                <input type="number" id="new-diaper-price" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateDiaperTotalPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">总价(元)</label>
                                <input type="number" id="new-diaper-total-price" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateDiaperPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">购买数量(包) *</label>
                                <input type="number" id="new-diaper-purchase-quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate(); calculateDiaperTotalPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">拿走数量(包) *</label>
                                <input type="number" id="new-diaper-take-quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="new-diaper-storage" class="mr-2" onchange="toggleStorageQuantity('diaper')">
                                    <label class="block text-sm font-medium text-gray-700">需要寄存</label>
                                </div>
                                <div id="new-diaper-storage-quantity-container" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">寄存数量(包)</label>
                                    <input type="number" id="new-diaper-storage-quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">取货日期 *</label>
                                <input type="date" id="new-diaper-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" onchange="calculateEndDate()">
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex items-center space-x-2 mb-2">
                                    <label class="block text-sm font-medium text-gray-700">预计用完日期</label>
                                    <button type="button" onclick="calculateEndDate()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                        <i class="fa fa-calculator mr-1"></i>重新计算
                                    </button>
                                </div>
                                <input type="date" id="new-diaper-end-date" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                            </div>
                        </div>
                    </div>

                    <!-- 营养品表单 -->
                    <div id="nutrition-form" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">产品名称 *</label>
                                <input type="text" id="new-nutrition-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">品牌 *</label>
                                <input type="text" id="new-nutrition-brand" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">用量类型 *</label>
                                <select id="new-nutrition-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" onchange="toggleNutritionFields(); calculateEndDate()">
                                    <option value="daily">正常用量</option>
                                    <option value="recommended">推荐用量</option>
                                </select>
                            </div>
                            <div id="daily-amount-container">
                                <label class="block text-sm font-medium text-gray-700 mb-2">每日使用量 *</label>
                                <input type="number" id="new-nutrition-daily" required min="0.1" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div id="recommended-container" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">每日使用量 *</label>
                                <input type="number" id="new-nutrition-recommended" required min="0.1" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">单价(元)</label>
                                <input type="number" id="new-nutrition-price" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateNutritionTotalPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">总价(元)</label>
                                <input type="number" id="new-nutrition-total-price" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateNutritionPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">购买数量 *</label>
                                <input type="number" id="new-nutrition-purchase-quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate(); calculateNutritionTotalPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">拿走数量 *</label>
                                <input type="number" id="new-nutrition-take-quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="calculateEndDate()">
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="new-nutrition-storage" class="mr-2" onchange="toggleStorageQuantity('nutrition')">
                                    <label class="block text-sm font-medium text-gray-700">需要寄存</label>
                                </div>
                                <div id="new-nutrition-storage-quantity-container" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">寄存数量</label>
                                    <input type="number" id="new-nutrition-storage-quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">取货日期 *</label>
                                <input type="date" id="new-nutrition-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" onchange="calculateEndDate()">
                            </div>
                            <div id="nutrition-reminder-container" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">回访提醒设置</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="nutrition-reminder" checked class="mr-2">
                                    <span class="text-xs text-gray-600">开始使用后前三天每天提醒，第四天开始每三天提醒，一周后每七天提醒</span>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex items-center space-x-2 mb-2">
                                    <label class="block text-sm font-medium text-gray-700">预计用完日期</label>
                                    <button type="button" onclick="calculateEndDate()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                        <i class="fa fa-calculator mr-1"></i>重新计算
                                    </button>
                                </div>
                                <input type="date" id="new-nutrition-end-date" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                <button type="button" onclick="closeModal('add-product-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    取消
                </button>
                <button type="button" id="saveProductButton" onclick="saveProductFromButton()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    保存产品记录
                </button>
            </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加联系记录模态框 -->
    <div id="add-contact-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[10001] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">添加联系记录</h3>
                    <button onclick="closeModal('add-contact-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="contact-record-form" onsubmit="saveContactRecord(event)">
                    <input type="hidden" id="contact-customer-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">联系方式 *</label>
                            <select id="contact-method" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">请选择联系方式</option>
                                <option value="电话">电话</option>
                                <option value="微信">微信</option>
                                <option value="到店">到店</option>
                                <option value="视频">视频</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">联系结果 *</label>
                            <select id="contact-result" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">请选择联系结果</option>
                                <option value="接通">接通</option>
                                <option value="未接通">未接通</option>
                                <option value="需要回访">需要回访</option>
                                <option value="已购买">已购买</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                            <textarea id="contact-remark" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请详细描述联系情况和客户反馈..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">下次联系时间</label>
                            <input type="date" id="next-contact-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeModal('add-contact-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            保存联系记录
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑提醒模态框 -->
    <div id="edit-reminder-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[10001] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-lg w-full">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">编辑提醒</h3>
                    <button onclick="closeModal('edit-reminder-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="edit-reminder-form" onsubmit="saveEditedReminder(event)">
                    <input type="hidden" id="edit-reminder-id">
                    <input type="hidden" id="edit-reminder-type">
                    <input type="hidden" id="edit-reminder-customer-id">
                    <input type="hidden" id="edit-reminder-related-id">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">提醒标题</label>
                        <input type="text" id="edit-reminder-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" readonly>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">提醒描述</label>
                        <textarea id="edit-reminder-description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" readonly></textarea>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">提醒日期</label>
                        <input type="date" id="edit-reminder-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeModal('edit-reminder-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            保存修改
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 统计模态框 -->
    <div id="statistics-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">数据统计</h3>
                    <button onclick="closeModal('statistics-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-blue-900 mb-2">总客户数</h4>
                        <p id="stat-total-customers" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-green-900 mb-2">活跃客户</h4>
                        <p id="stat-active-customers" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-purple-900 mb-2">营养品客户</h4>
                        <p id="stat-nutrition-customers" class="text-2xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-orange-900 mb-2">待回访客户</h4>
                        <p id="stat-follow-up-customers" class="text-2xl font-bold text-orange-600">0</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">客户状态分布</h4>
                        <div class="bg-white rounded-lg p-6">
                            <canvas id="statusChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">产品类型分布</h4>
                        <div class="bg-white rounded-lg p-6">
                            <canvas id="productChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 销售统计部分 -->
                <h2 class="text-xl font-bold text-gray-900 mb-4">销售统计和占比分析</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
                        <div class="text-sm font-medium text-gray-500">今日销售额</div>
                        <div class="mt-1 flex items-baseline">
                            <span class="text-2xl font-bold text-gray-900" id="sales-today">0.00</span>
                            <span class="ml-1 text-sm text-gray-500">元</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
                        <div class="text-sm font-medium text-gray-500">本周销售额</div>
                        <div class="mt-1 flex items-baseline">
                            <span class="text-2xl font-bold text-gray-900" id="sales-week">0.00</span>
                            <span class="ml-1 text-sm text-gray-500">元</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
                        <div class="text-sm font-medium text-gray-500">本月销售额</div>
                        <div class="mt-1 flex items-baseline">
                            <span class="text-2xl font-bold text-gray-900" id="sales-month">0.00</span>
                            <span class="ml-1 text-sm text-gray-500">元</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-teal-500">
                        <div class="text-sm font-medium text-gray-500">本季度销售额</div>
                        <div class="mt-1 flex items-baseline">
                            <span class="text-2xl font-bold text-gray-900" id="sales-quarter">0.00</span>
                            <span class="ml-1 text-sm text-gray-500">元</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                        <div class="text-sm font-medium text-gray-500">本年销售额</div>
                        <div class="mt-1 flex items-baseline">
                            <span class="text-2xl font-bold text-gray-900" id="sales-year">0.00</span>
                            <span class="ml-1 text-sm text-gray-500">元</span>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">销售额趋势分析</h4>
                        <div class="bg-white rounded-lg p-6">
                            <canvas id="salesChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">产品销售占比</h4>
                        <div class="bg-white rounded-lg p-6">
                            <canvas id="productSalesChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">时间段销售统计</h4>
                    
                    <!-- 时间段选择按钮 -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button id="btn-today" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors active-period-btn">今日</button>
                        <button id="btn-week" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">本周</button>
                        <button id="btn-month" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors">本月</button>
                        <button id="btn-quarter" class="px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 transition-colors">本季度</button>
                        <button id="btn-year" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition-colors">本年</button>
                    </div>
                    
                    <!-- 当前时间段销售总额 -->
                    <div class="text-center mb-4">
                        <div class="text-sm text-gray-500">当前统计时段</div>
                        <div class="text-3xl font-bold text-gray-900" id="current-period-sales">0.00 元</div>
                    </div>
                    
                    <!-- 产品类型销售统计 -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="border border-gray-200 rounded-lg p-4 flex flex-col items-center">
                            <div class="text-sm text-blue-500 mb-1">奶粉销售额</div>
                            <div class="text-2xl font-bold text-gray-900 mb-1" id="sales-milk">0.00</div>
                            <div class="text-sm text-gray-500" id="sales-milk-percentage">0%</div>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4 flex flex-col items-center">
                            <div class="text-sm text-green-500 mb-1">尿不湿销售额</div>
                            <div class="text-2xl font-bold text-gray-900 mb-1" id="sales-diaper">0.00</div>
                            <div class="text-sm text-gray-500" id="sales-diaper-percentage">0%</div>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4 flex flex-col items-center">
                            <div class="text-sm text-yellow-500 mb-1">营养品销售额</div>
                            <div class="text-2xl font-bold text-gray-900 mb-1" id="sales-nutrition">0.00</div>
                            <div class="text-sm text-gray-500" id="sales-nutrition-percentage">0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">客户销售明细</h4>
                    <div id="customer-sales-detail">
                        <p class="text-gray-500 text-center py-4">加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">系统设置</h3>
                    <button onclick="closeModal('settings-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="settings-form" onsubmit="saveSettings(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">提前提醒天数</label>
                            <input type="number" id="reminder-days" min="1" max="30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">产品到期前几天开始提醒</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">默认归属人</label>
                            <input type="text" id="default-owner" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">新客户默认归属人</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeModal('settings-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            保存设置
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 数据管理模态框 -->
    <div id="data-management-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">数据管理</h3>
                    <button onclick="closeModal('data-management-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-blue-900 mb-4">导出数据</h4>
                        <p class="text-blue-700 mb-4">将所有客户数据导出为JSON文件进行备份</p>
                        <button onclick="exportData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fa fa-download mr-2"></i>导出数据
                        </button>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-green-900 mb-4">导入数据（覆盖）</h4>
                        <p class="text-green-700 mb-4">从JSON文件导入之前备份的数据，会覆盖现有数据</p>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                            <button type="button" onclick="document.getElementById('import-file').click()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fa fa-upload mr-2"></i>选择文件
                            </button>
                            <span id="file-name" class="text-sm text-gray-600">未选择文件</span>
                        </div>
                    </div>
                    <!-- 新增：Bag导入功能 -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-purple-900 mb-4">Bag导入（合并）</h4>
                        <p class="text-purple-700 mb-4">从JSON文件导入数据，与现有数据合并，不会覆盖</p>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="bag-import-file" accept=".json" class="hidden" onchange="bagImportData(event)">
                            <button type="button" onclick="document.getElementById('bag-import-file').click()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                                <i class="fa fa-bag mr-2"></i>选择Bag文件
                            </button>
                            <span id="bag-file-name" class="text-sm text-gray-600">未选择文件</span>
                        </div>
                    </div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-red-900 mb-4">清空数据</h4>
                    <p class="text-red-700 mb-4">警告：此操作将删除所有客户数据，且无法恢复！</p>
                    <button onclick="confirmClearData()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fa fa-trash mr-2"></i>清空所有数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 合并客户模态框 -->
    <div id="merge-customers-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">合并重复客户</h3>
                    <button onclick="closeModal('merge-customers-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="duplicate-customers-list">
                    <!-- 重复客户列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 寄存管理模态框 -->
    <div id="storage-management-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">寄存管理</h3>
                    <button onclick="closeModal('storage-management-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="showAddStorageModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fa fa-plus mr-2"></i>添加寄存记录
                    </button>
                    <div class="relative">
                        <input type="text" id="search-storage" placeholder="搜索客户..." class="w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="searchStorage()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div id="storage-records-list" class="space-y-4">
                    <!-- 寄存记录列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 添加寄存模态框 -->
    <div id="add-storage-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">添加寄存记录</h3>
                    <button onclick="closeModal('add-storage-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="add-storage-form" onsubmit="saveStorageRecord(event)">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">搜索客户 *</label>
                        <div class="relative">
                            <input type="text" id="storage-customer-search" placeholder="输入客户名称或电话进行搜索..." 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent mb-2">
                            <div id="customer-search-results" class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                                <!-- 搜索结果将在这里动态生成 -->
                            </div>
                        </div>
                        <input type="hidden" id="storage-customer-select" required>
                        <p id="selected-customer-info" class="text-sm text-gray-500">请选择客户</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">产品名称 *</label>
                            <input type="text" id="storage-product-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">品牌</label>
                            <input type="text" id="storage-brand" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">寄存数量 *</label>
                            <input type="number" id="storage-quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">寄存日期 *</label>
                            <input type="date" id="storage-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">预计可用时间（天）</label>
                            <input type="number" id="storage-expected-days" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                            <textarea id="storage-note" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入备注信息..."></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeModal('add-storage-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            保存寄存记录
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 取货模态框 -->
    <div id="pickup-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[99999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">取货登记</h3>
                    <button onclick="closeModal('pickup-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="pickup-form" onsubmit="savePickupRecord(event)">
                    <input type="hidden" id="pickup-storage-id">
                    
                    <!-- 寄存记录搜索 -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">搜索寄存记录 *</label>
                        <div class="relative">
                            <input type="text" id="pickup-search-input" placeholder="输入客户名称、产品名称进行搜索..." 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent mb-2">
                            <div id="pickup-search-results" class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                                <!-- 搜索结果将在这里动态生成 -->
                            </div>
                        </div>
                        <p id="selected-storage-info" class="text-sm text-gray-500">请选择寄存记录</p>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">寄存信息</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p id="storage-info" class="text-gray-700"></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">取货数量 *</label>
                            <input type="number" id="pickup-quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <p id="quantity-warning" class="text-xs text-red-500 mt-1 hidden">取货数量不能大于剩余数量</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">取货日期 *</label>
                            <input type="date" id="pickup-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                            <textarea id="pickup-note" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入备注信息..."></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeModal('pickup-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            确认取货
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">使用帮助</h3>
                    <button onclick="closeModal('help-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">1. 如何添加客户？</h4>
                        <p class="text-gray-700">点击"添加客户"按钮，填写客户基本信息和宝宝信息，点击保存即可创建新客户档案。</p>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">2. 如何添加产品记录？</h4>
                        <p class="text-gray-700">点击"添加产品"按钮，选择客户和产品类型，填写产品详细信息，系统会自动计算预计用完日期。</p>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">3. 如何查看提醒？</h4>
                        <p class="text-gray-700">在首页的"今日提醒"区域可以查看所有需要处理的提醒，包括产品到期和客户回访。</p>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">4. 如何备份数据？</h4>
                        <p class="text-gray-700">点击顶部导航的"数据管理"，选择"导出数据"可以将所有客户数据备份为JSON文件。</p>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">5. 如何使用寄存管理？</h4>
                        <p class="text-gray-700">点击"寄存管理"按钮，可以添加、查看和管理客户的产品寄存记录，支持取货登记功能。</p>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">6. 如何使用Bag导入功能？</h4>
                        <p class="text-gray-700">点击顶部导航的"数据管理"，选择"Bag导入（合并）"可以导入数据而不覆盖现有数据，新数据会与现有数据合并。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let customers = [];
        let storageRecords = [];
        let settings = {
            reminderDays: 7,
            defaultOwner: ''
        };
        let completedReminders = [];
        let historicalReminders = [];
        let customerToDelete = null;

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // 初始化回访设置
            initCustomerFollowUpSettings();
            
            // 确保在使用之前定义了这些函数
            if (typeof initializeProductTypes === 'function') {
                initializeProductTypes();
            }
            
            updateDashboard();
            updateCustomerList();
            updateTodayReminders();
            updateHistoricalReminders();
            updateDueDateList();
            updateProductUsageList();
            updateStorageManagementList();
            setCurrentMonth();
            addEventListeners();
        });

        // 添加事件监听器
        function addEventListeners() {
            // 搜索客户
            const searchCustomer = document.getElementById('search-customer');
            if (searchCustomer) searchCustomer.addEventListener('input', filterCustomers);
            
            // 保存产品按钮现在通过onclick直接调用saveProductFromButton函数
            
            // 产品表单计算 - 添加元素存在性检查
            const milkWeight = document.getElementById('new-milk-weight');
            const milkQuantity = document.getElementById('new-milk-quantity');
            const milkWater = document.getElementById('new-milk-water');
            const milkSpoonWeight = document.getElementById('new-milk-spoon-weight');
            const milkDailyAmount = document.getElementById('new-milk-daily-amount');
            const milkDate = document.getElementById('new-milk-date');
            const diaperQuantity = document.getElementById('new-diaper-quantity');
            const diaperDate = document.getElementById('new-diaper-date');
            
            if (milkWeight) milkWeight.addEventListener('input', calculateEndDate);
            if (milkQuantity) milkQuantity.addEventListener('input', calculateEndDate);
            if (milkWater) milkWater.addEventListener('input', calculateEndDate);
            if (milkSpoonWeight) milkSpoonWeight.addEventListener('input', calculateEndDate);
            if (milkDailyAmount) milkDailyAmount.addEventListener('input', calculateEndDate);
            if (milkDate) milkDate.addEventListener('input', calculateEndDate);
            if (diaperQuantity) diaperQuantity.addEventListener('input', calculateEndDate);
            if (diaperDate) diaperDate.addEventListener('input', calculateEndDate);

            // 取货数量验证
            document.getElementById('pickup-quantity').addEventListener('input', validatePickupQuantity);
        }

        // 数据加载和保存
        function loadData() {
            try {
                // 加载客户数据
                const savedCustomers = localStorage.getItem('motherBabyCustomers');
                if (savedCustomers) {
                    const parsedCustomers = JSON.parse(savedCustomers);
                    if (Array.isArray(parsedCustomers)) {
                        customers = parsedCustomers;
                        console.log('客户数据加载成功，共', customers.length, '条记录');
                    }
                }
                
                // 加载寄存记录
                const savedStorage = localStorage.getItem('motherBabyStorage');
                if (savedStorage) {
                    const parsedStorage = JSON.parse(savedStorage);
                    if (Array.isArray(parsedStorage)) {
                        storageRecords = parsedStorage;
                        // 初始化expectedPickupDates字段并为所有记录计算预计取货日期
                        storageRecords.forEach(record => {
                            if (!record.expectedPickupDates) {
                                record.expectedPickupDates = [];
                            }
                            // 确保takeQuantity有值
                            if (!record.takeQuantity) {
                                // 没有取货数量，无法计算预计取货时间
                                record.takeQuantity = undefined;
                            }
                            // 计算预计取货日期
                            calculateExpectedPickupDates(record, record.takeQuantity);
                        });
                        console.log('寄存记录加载成功，共', storageRecords.length, '条记录');
                    }
                }
                
                // 加载设置数据
                const savedSettings = localStorage.getItem('motherBabySettings');
                if (savedSettings) {
                    try {
                        const parsedSettings = JSON.parse(savedSettings);
                        console.log('原始设置数据:', parsedSettings);
                        
                        // 合并设置，确保必要的属性存在
                        settings = {
                            ...settings, // 保留默认值
                            ...parsedSettings // 覆盖用户设置
                        };
                        
                        // 验证并修复设置值
                        settings.reminderDays = parseInt(settings.reminderDays) || 7;
                        settings.defaultOwner = settings.defaultOwner || '';
                        
                        console.log('设置数据加载成功:', settings);
                    } catch (e) {
                        console.error('解析设置数据失败:', e);
                        // 如果解析失败，使用默认设置
                        settings = { reminderDays: 7, defaultOwner: '' };
                        console.log('使用默认设置:', settings);
                    }
                }
                
                // 加载已完成提醒
                const savedCompleted = localStorage.getItem('motherBabyCompletedReminders');
                if (savedCompleted) {
                    const parsedCompleted = JSON.parse(savedCompleted);
                    if (Array.isArray(parsedCompleted)) {
                        completedReminders = parsedCompleted;
                        console.log('已完成提醒加载成功，共', completedReminders.length, '条记录');
                    }
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                // 重置为默认值
                settings = { reminderDays: 7, defaultOwner: '' };
                console.log('发生错误，重置设置为默认值:', settings);
            }
        }

        function saveData() {
            try {
                console.log('saveData被调用');
                // 验证数据结构
                if (!Array.isArray(customers)) {
                    console.error('客户数据不是有效的数组');
                    customers = [];
                }
                
                if (!Array.isArray(storageRecords)) {
                    console.error('寄存记录不是有效的数组');
                    storageRecords = [];
                }
                
                if (!Array.isArray(completedReminders)) {
                    console.error('已完成提醒不是有效的数组');
                    completedReminders = [];
                }
                
                // 验证设置对象
                if (!settings || typeof settings !== 'object') {
                    console.error('设置对象无效，重置为默认值');
                    settings = { reminderDays: 7, defaultOwner: '' };
                }
                
                // 确保设置对象包含必要的属性
                settings.reminderDays = parseInt(settings.reminderDays) || 7;
                settings.defaultOwner = settings.defaultOwner || '';
                
                // 保存数据
                console.log('开始保存数据...');
                localStorage.setItem('motherBabyCustomers', JSON.stringify(customers));
                localStorage.setItem('motherBabyStorage', JSON.stringify(storageRecords));
                localStorage.setItem('motherBabySettings', JSON.stringify(settings));
                localStorage.setItem('motherBabyCompletedReminders', JSON.stringify(completedReminders));
                
                // 确保completionDates存在并保存到localStorage
                if (!window.completionDates) {
                    window.completionDates = {};
                }
                localStorage.setItem('motherBabyReminderCompletionDates', JSON.stringify(window.completionDates));
                
                // 验证completedReminders是否保存成功
                const savedCompletedReminders = localStorage.getItem('motherBabyCompletedReminders');
                if (savedCompletedReminders) {
                    const parsedCompleted = JSON.parse(savedCompletedReminders);
                    console.log('已完成提醒保存验证成功:', parsedCompleted);
                } else {
                    console.error('已完成提醒保存失败！');
                }
                
                console.log('数据保存成功:');
                console.log('- 客户数据:', customers.length, '条');
                console.log('- 寄存记录:', storageRecords.length, '条');
                console.log('- 设置数据:', settings);
                console.log('- 已完成提醒:', completedReminders.length, '条');
                
                // 保存成功，静默操作，不显示提示
            } catch (error) {
                console.error('保存数据失败:', error);
                // 显示错误通知
                showNotification('保存数据失败，请重试！', 'error');
            }
        }
        
        // 初始化客户回访设置
        function initCustomerFollowUpSettings() {
            customers.forEach(customer => {
                // 如果客户没有回访设置，添加默认设置
                if (!customer.followUpSettings) {
                    customer.followUpSettings = {
                        enabled: true,
                        frequency: 'weekly',
                        timesPerWeek: 1,
                        nextFollowUpDate: new Date().toISOString().split('T')[0]
                    };
                    // 为这个客户生成回访计划
                    generateFollowUpPlan(customer.id);
                }
            });
            // 保存更新后的数据
            saveData();
        }
        
        // 重新生成所有客户的回访计划
        function regenerateAllFollowUpPlans() {
            if (confirm('确定要重新生成所有客户的回访计划吗？')) {
                customers.forEach(customer => {
                    if (customer.followUpSettings && customer.followUpSettings.enabled) {
                        generateFollowUpPlan(customer.id);
                    }
                });
                saveData();
                updateTodayReminders();
                updateDashboard();
                showNotification('回访计划已重新生成！', 'success');
            }
        }

        // 模态框操作
function showModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    // 滚动到顶部，确保模态框居中显示
    window.scrollTo(0, 0);
}

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // 显示添加客户模态框
        function showAddCustomerModal() {
            document.getElementById('add-customer-form').reset();
            document.getElementById('allergy-info-container').classList.add('hidden');
            document.getElementById('babies-container').innerHTML = `
                <div class="baby-form grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 border border-dashed border-gray-300 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">宝宝姓名 *</label>
                        <input type="text" class="baby-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">出生日期</label>
                        <input type="date" class="baby-birthdate w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">或通过年龄计算</label>
                        <div class="flex space-x-2">
                            <input type="number" class="baby-age-years w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="岁">
                            <input type="number" class="baby-age-months w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="月">
                            <button type="button" onclick="calculateBirthdate(this)" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fa fa-calculator"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">性别</label>
                        <select class="baby-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">请选择</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <div class="md:col-span-5">
                        <button type="button" onclick="removeBabyForm(this)" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fa fa-trash mr-2"></i>删除
                        </button>
                    </div>
                </div>
            `;
            if (settings.defaultOwner) {
                document.getElementById('new-customer-owner').value = settings.defaultOwner;
            }
            showModal('add-customer-modal');
        }

        // 保存客户
        function saveCustomer(event) {
            event.preventDefault();
            
            const newCustomer = {
                id: Date.now(),
                name: document.getElementById('new-customer-name').value,
                phone: document.getElementById('new-customer-phone').value,
                wechat: document.getElementById('new-customer-wechat').value,
                identity: document.getElementById('new-customer-identity').value,
                owner: document.getElementById('new-customer-owner').value,
                dueDate: document.getElementById('new-customer-due-date').value,
                status: document.getElementById('new-customer-status').value,
                allergic: document.getElementById('new-customer-allergic').value,
                allergyInfo: document.getElementById('new-customer-allergy-info').value,
                babies: [],
                products: [],
                contacts: [],
                followUpSettings: {
                    enabled: true,
                    frequency: 'weekly',
                    timesPerWeek: 1,
                    nextFollowUpDate: new Date().toISOString().split('T')[0]
                },
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // 收集宝宝信息
            const babyForms = document.querySelectorAll('.baby-form');
            babyForms.forEach(form => {
                const name = form.querySelector('.baby-name').value;
                if (name) {
                    newCustomer.babies.push({
                        name: name,
                        birthDate: form.querySelector('.baby-birthdate').value,
                        gender: form.querySelector('.baby-gender').value
                    });
                }
            });

            customers.push(newCustomer);
            
            // 生成回访计划
            generateFollowUpPlan(newCustomer.id);
            
            saveData();
            closeModal('add-customer-modal');
            updateDashboard();
            updateCustomerList();
            updateOwnerFilter();
            
            // 显示成功消息
            showNotification('客户添加成功！', 'success');
        }

        // 添加宝宝表单
        function addBabyForm() {
            const container = document.getElementById('babies-container');
            const newForm = document.createElement('div');
            newForm.className = 'baby-form grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 border border-dashed border-gray-300 rounded-lg';
            newForm.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">宝宝姓名 *</label>
                    <input type="text" class="baby-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">出生日期</label>
                    <input type="date" class="baby-birthdate w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">或通过年龄计算</label>
                    <div class="flex space-x-2">
                        <input type="number" class="baby-age-years w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="岁">
                        <input type="number" class="baby-age-months w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="月">
                        <button type="button" onclick="calculateBirthdate(this)" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fa fa-calculator"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">性别</label>
                    <select class="baby-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">请选择</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </div>
                <div class="md:col-span-5">
                    <button type="button" onclick="removeBabyForm(this)" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fa fa-trash mr-2"></i>删除
                    </button>
                </div>
            `;
            container.appendChild(newForm);
        }

        // 移除宝宝表单
        function removeBabyForm(button) {
            const form = button.closest('.baby-form');
            const container = document.getElementById('babies-container');
            
            if (container.children.length > 1) {
                form.remove();
            } else {
                showNotification('至少需要保留一个宝宝信息！', 'warning');
            }
        }

        // 切换过敏信息显示
        function toggleAllergyInfo() {
            const allergic = document.getElementById('new-customer-allergic').value;
            const container = document.getElementById('allergy-info-container');
            
            if (allergic === '是') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // 根据年龄计算出生日期
        function calculateBirthdate(button) {
            const form = button.closest('.baby-form');
            const years = parseInt(form.querySelector('.baby-age-years').value) || 0;
            const months = parseInt(form.querySelector('.baby-age-months').value) || 0;
            
            if (years === 0 && months === 0) {
                showNotification('请输入年龄或月龄！', 'warning');
                return;
            }
            
            const birthDate = new Date();
            birthDate.setFullYear(birthDate.getFullYear() - years);
            birthDate.setMonth(birthDate.getMonth() - months);
            
            // 格式化为YYYY-MM-DD
            const formattedDate = birthDate.toISOString().split('T')[0];
            form.querySelector('.baby-birthdate').value = formattedDate;
            
            showNotification('出生日期已计算完成！', 'success');
        }

        // 更新客户列表
        function updateCustomerList() {
            const list = document.getElementById('customers-list');
            const filteredCustomers = getFilteredCustomers();
            
            if (filteredCustomers.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">暂无客户数据，请添加客户信息</p>';
                return;
            }

            list.innerHTML = filteredCustomers.map(customer => `
                <div class="bg-white rounded-lg p-6 border border-gray-200 hover:shadow-lg transition-shadow cursor-pointer slide-in" onclick="showCustomerDetail(${customer.id})">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${customer.name}</h3>
                            <p class="text-sm text-gray-600">${customer.phone} | ${customer.owner}</p>
                            <p class="text-sm text-gray-600">${customer.identity || '未填写'}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(customer.status)}">${customer.status}</span>
                    </div>
                    
                    ${customer.allergic === '是' ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                            <p class="text-sm text-red-700">
                                <i class="fa fa-exclamation-triangle mr-2"></i>
                                过敏提醒：${customer.allergyInfo}
                            </p>
                        </div>
                    ` : ''}

                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">宝宝信息</h4>
                        <div class="space-y-2">
                            ${customer.babies.map(baby => `
                                <p class="text-sm text-gray-600">${baby.name}(${baby.gender || '未知'}) - ${getAge(baby.birthDate)}</p>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-2">
                            <button onclick="event.stopPropagation(); editCustomer(${customer.id})" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                <i class="fa fa-edit mr-1"></i>编辑
                            </button>
                            <button onclick="event.stopPropagation(); showAddContactModalForCustomer(${customer.id})" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                                <i class="fa fa-phone mr-1"></i>联系
                            </button>
                            <button onclick="event.stopPropagation(); showAddProductModalForCustomer(${customer.id})" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors text-sm">
                                <i class="fa fa-shopping-cart mr-1"></i>添加产品
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 显示客户详情
        function showCustomerDetail(customerId) {
            const customer = customers.find(c => c.id === customerId);

            if (!customer) return;
            
            customerToDelete = customerId;
            const modal = document.getElementById('customer-detail-modal');
            // 设置客户ID到模态框的dataset，用于后续刷新
            modal.dataset.customerId = customerId;
            document.getElementById('customer-detail-title').textContent = customer.name + ' - 客户详情';
            
            // 获取客户的寄存记录（显示所有记录，包括已取完的）
            const customerStorageRecords = storageRecords.filter(record => record.customerId === customerId);

            let detailHTML = `
                <div class="space-y-6">
                    <!-- 客户基本信息 -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">基本信息</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">客户姓名</p>
                                <p class="font-medium">${customer.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">联系电话</p>
                                <p class="font-medium">${customer.phone}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">微信号</p>
                                <p class="font-medium">${customer.wechat || '未填写'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">客户身份</p>
                                <p class="font-medium">${customer.identity || '未填写'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">归属人</p>
                                <p class="font-medium">${customer.owner}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">预产期</p>
                                <p class="font-medium">${customer.dueDate ? formatMonth(customer.dueDate) : '未填写'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">客户状态</p>
                                <p class="font-medium ${getStatusBadgeClass(customer.status)}">${customer.status}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">创建时间</p>
                                <p class="font-medium">${formatDate(customer.createdAt)}</p>
                            </div>
                        </div>
            `;

            if (customer.allergic === '是') {
                detailHTML += `
                    <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-3">
                        <p class="text-sm text-red-700">
                            <i class="fa fa-exclamation-triangle mr-2"></i>
                            过敏提醒：${customer.allergyInfo}
                        </p>
                    </div>
                `;
            }

            detailHTML += `
                    </div>
            `;

            // 宝宝信息
            if (customer.babies && customer.babies.length > 0) {
                detailHTML += `
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">宝宝信息</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                customer.babies.forEach(baby => {
                    let ageDetails = '';
                    if (baby.birthDate) {
                        const ageInDays = calculateAgeInDays(baby.birthDate);
                        if (ageInDays >= 180) { // 6个月以上
                            ageDetails = '<p class="text-sm text-orange-600 mt-2"><i class="fa fa-bullseye mr-1"></i>已超过6个月，建议关注成长发育</p>';
                        } else if (ageInDays >= 175) { // 即将满6个月
                            ageDetails = '<p class="text-sm text-yellow-600 mt-2"><i class="fa fa-clock-o mr-1"></i>即将满6个月，请注意成长发育</p>';
                        }
                    }
                    
                    detailHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900">${baby.name}</h5>
                            <p class="text-sm text-gray-600">性别：${baby.gender || '未知'}</p>
                            <p class="text-sm text-gray-600">出生日期：${baby.birthDate || '未填写'}</p>
                            <p class="text-sm text-gray-600">年龄：${getAge(baby.birthDate)}</p>
                            ${ageDetails}
                        </div>
                    `;
                });
                
                detailHTML += `
                        </div>
                    </div>
                `;
            }

            // 添加切换按钮
            detailHTML += `
                <div class="flex mb-4">
                    <button id="product-records-btn" class="mr-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">产品使用记录</button>
                    <button id="contact-records-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">联系记录</button>
                </div>
            `;
            
            // 产品记录容器
            detailHTML += `
                <div id="product-records-container">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">产品使用记录</h4>
                        <div>
                            <select id="product-filter" class="px-2 py-1 border border-gray-300 rounded">
                                <option value="all" selected>全部</option>
                                <option value="recent">近30天</option>
                                <option value="last7">近7天</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4">
            `;
            
            // 产品记录筛选
            const currentDate = new Date();
            const productFilterElement = document.getElementById('product-filter');
            const productFilterValue = productFilterElement ? productFilterElement.value : 'all';
            
            let filteredProducts = [...customer.products];
            if (productFilterValue === 'recent') {
                const recentDate = new Date(currentDate.setMonth(currentDate.getMonth() - 1));
                filteredProducts = filteredProducts.filter(product => new Date(product.date) >= recentDate);
            } else if (productFilterValue === 'last7') {
                const last7Date = new Date(currentDate.setDate(currentDate.getDate() - 7));
                filteredProducts = filteredProducts.filter(product => new Date(product.date) >= last7Date);
            }
            
            // 按取货日期从近往远排序
            const sortedProducts = filteredProducts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedProducts.forEach(product => {
                    let statusClass = 'bg-green-100 text-green-800';
                    let statusText = '使用中';
                    
                    if (product.endDate && new Date(product.endDate) < new Date()) {
                        statusClass = 'bg-red-100 text-red-800';
                        statusText = '已过期';
                    }
                    
                    let productDetails = '';
                    if (product.type === 'milk') {
                        productDetails = `
                            <div>
                                <p class="text-gray-500">阶段</p>
                                <p class="text-gray-700">${product.stage}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">每罐重量</p>
                                <p class="text-gray-700">${product.weight}克</p>
                            </div>
                            <div>
                                <p class="text-gray-500">每勺奶粉重量</p>
                                <p class="text-gray-700">${product.spoonWeight || 4.3}克</p>
                            </div>
                            <div>
                                <p class="text-gray-500">每日奶量</p>
                                <p class="text-gray-700">${product.dailyMl}毫升</p>
                            </div>
                        `;
                    } else if (product.type === 'diaper') {
                        productDetails = `
                            <div>
                                <p class="text-gray-500">规格</p>
                                <p class="text-gray-700">${product.size}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">购买包数</p>
                                <p class="text-gray-700">${product.purchaseQuantity || product.quantity}包</p>
                            </div>
                            <div>
                                <p class="text-gray-500">拿走包数</p>
                                <p class="text-gray-700">${product.takeQuantity || product.quantity}包</p>
                            </div>
                            ${product.needStorage ? `
                            <div>
                                <p class="text-gray-500">寄存包数</p>
                                <p class="text-gray-700">${product.storageQuantity}包</p>
                            </div>
                            ` : ''}
                        `;
                    } else if (product.type === 'nutrition') {
                        productDetails = `
                            <div>
                                <p class="text-gray-500">产品名称</p>
                                <p class="text-gray-700">${product.name}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">用量</p>
                                <p class="text-gray-700">${product.dailyAmount || product.recommendedAmount}</p>
                            </div>
                        `;
                    }
                    
                    const daysLeft = product.endDate ? Math.ceil((new Date(product.endDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                    let daysLeftText = '';
                    if (daysLeft !== null) {
                        if (daysLeft < 0) {
                            daysLeftText = `<span class="text-red-600">已过期${Math.abs(daysLeft)}天</span>`;
                        } else if (daysLeft === 0) {
                            daysLeftText = '<span class="text-red-600">今天到期</span>';
                        } else if (daysLeft === 1) {
                            daysLeftText = '<span class="text-orange-600">明天到期</span>';
                        } else if (daysLeft < 7) {
                            daysLeftText = `<span class="text-orange-600">${daysLeft}天后到期</span>`;
                        } else {
                            daysLeftText = `${daysLeft}天后到期`;
                        }
                    }
                    
                    detailHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h5 class="text-lg font-medium text-gray-900">${getProductTypeName(product.type)} - ${product.brand}</h5>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">取货日期</p>
                                    <p class="font-medium">${formatDate(product.date)}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                ${productDetails}
                                <div>
                                    <p class="text-gray-500">购买数量</p>
                                    <p class="text-gray-700">${product.purchaseQuantity || product.quantity} ${product.type === 'milk' ? '罐' : product.type === 'diaper' ? '包' : '个'}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500">拿走数量</p>
                                    <p class="text-gray-700">${product.takeQuantity || product.quantity} ${product.type === 'milk' ? '罐' : product.type === 'diaper' ? '包' : '个'}</p>
                                </div>
                                ${product.needStorage ? `
                                <div>
                                    <p class="text-gray-500">寄存数量</p>
                                    <p class="text-gray-700">${product.storageQuantity} ${product.type === 'milk' ? '罐' : product.type === 'diaper' ? '包' : '个'}</p>
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-gray-600">预计用完日期</p>
                                    <p class="font-medium">${product.endDate ? formatDate(product.endDate) : '未设置'}</p>
                                </div>
                                ${daysLeft !== null ? `
                                    <div class="text-right">
                                        <p class="text-sm text-gray-600">剩余时间</p>
                                        <p class="font-medium ${daysLeft < 7 && daysLeft >= 0 ? 'text-orange-600' : daysLeft < 0 ? 'text-red-600' : 'text-gray-700'}">${daysLeftText}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                detailHTML += `
                    </div>
                </div>
            `;
            
            // 联系记录容器（默认隐藏）
            detailHTML += `
                <div id="contact-records-container" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">联系记录</h4>
                        <div>
                            <select id="contact-filter" class="px-2 py-1 border border-gray-300 rounded">
                                <option value="all" selected>全部</option>
                                <option value="recent">近30天</option>
                                <option value="last7">近7天</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4">
            `;
            
            // 联系记录
            if (customer.contacts && customer.contacts.length > 0) {
                // 联系记录筛选
                const contactFilterElement = document.getElementById('contact-filter');
                const contactFilterValue = contactFilterElement ? contactFilterElement.value : 'all';
                
                let filteredContacts = [...customer.contacts];
                if (contactFilterValue === 'recent') {
                    const recentDate = new Date(currentDate.setMonth(currentDate.getMonth() - 1));
                    filteredContacts = filteredContacts.filter(contact => new Date(contact.date) >= recentDate);
                } else if (contactFilterValue === 'last7') {
                    const last7Date = new Date(currentDate.setDate(currentDate.getDate() - 7));
                    filteredContacts = filteredContacts.filter(contact => new Date(contact.date) >= last7Date);
                }
                
                // 按日期从近往远排序
                const sortedContacts = filteredContacts.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedContacts.forEach(contact => {
                    detailHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h5 class="text-lg font-medium text-gray-900">${contact.method} - ${contact.result}</h5>
                                    <p class="text-sm text-gray-600">${formatDate(contact.date)}</p>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${getContactResultClass(contact.result)}">${contact.result}</span>
                            </div>
                            <div class="mb-4">
                                <h6 class="text-sm font-medium text-gray-700 mb-2">备注</h6>
                                <p class="text-sm text-gray-600">${contact.remark || '无'}</p>
                            </div>
                            ${contact.nextContactDate ? `
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <p class="text-sm text-blue-700">
                                        <i class="fa fa-bell mr-2"></i>
                                        下次联系时间：${formatDate(contact.nextContactDate)}
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                detailHTML += `
                        </div>
                    </div>
                `;
            }

            // 寄存记录
            if (customerStorageRecords.length > 0) {
                // 按寄存日期从近到远排序
                const sortedStorageRecords = [...customerStorageRecords].sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
                
                detailHTML += `
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">寄存记录</h4>
                        <div class="space-y-4">
                `;
                
                sortedStorageRecords.forEach(record => {
                    detailHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h5 class="text-lg font-medium text-gray-900">${record.productName} - ${record.brand || '未填写'}</h5>
                                    <p class="text-sm text-gray-600">寄存日期：${formatDate(record.storageDate)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">寄存数量</p>
                                    <p class="font-medium">${record.quantity}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <p class="text-gray-500">剩余数量</p>
                                    <p class="text-gray-700">${record.remainingQuantity}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500">已取数量</p>
                                    <p class="text-gray-700">${record.quantity - record.remainingQuantity}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500">取货次数</p>
                                    <p class="text-gray-700">${record.pickups ? record.pickups.length : 0}次</p>
                                </div>

                            </div>
                            ${record.expectedPickupDates && record.expectedPickupDates.length > 0 ? `
                            <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm font-semibold text-blue-800 mb-2">预计取货时间</p>
                                <div class="flex flex-wrap gap-2">
                                    ${record.expectedPickupDates.map(date => `
                                        <span class="px-3 py-1 bg-white border border-blue-300 rounded-full text-sm text-blue-700">
                                            ${formatDate(date)}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                            <div class="flex justify-end">
                                <button onclick="event.stopPropagation(); showPickupModal(${record.id})" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                                    <i class="fa fa-shopping-cart mr-1"></i>取货登记
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                detailHTML += `
                        </div>
                    </div>
                `;
            }

            // 操作按钮
            detailHTML += `
                <div class="flex space-x-4">
                    <button onclick="deleteCustomer()" class="flex-1 bg-red-500 text-white py-3 px-6 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fa fa-trash mr-2"></i>删除客户
                    </button>
                    <button onclick="editCustomer(${customer.id})" class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fa fa-edit mr-2"></i>编辑客户信息
                    </button>
                    <button onclick="showAddProductModalForCustomer(${customer.id})" class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fa fa-shopping-cart mr-2"></i>添加产品记录
                    </button>
                    <button onclick="showAddContactModalForCustomer(${customer.id})" class="flex-1 bg-purple-500 text-white py-3 px-6 rounded-lg hover:bg-purple-600 transition-colors">
                        <i class="fa fa-phone mr-2"></i>添加联系记录
                    </button>
                </div>
            `;

            detailHTML += `
                </div>
            `;
            
            document.getElementById('customer-detail-content').innerHTML = detailHTML;
            showModal('customer-detail-modal');
            
            // 为切换按钮添加事件监听器
            document.getElementById('product-records-btn').addEventListener('click', () => {
                document.getElementById('product-records-btn').className = 'mr-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                document.getElementById('contact-records-btn').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
                document.getElementById('product-records-container').classList.remove('hidden');
                document.getElementById('contact-records-container').classList.add('hidden');
            });
            
            document.getElementById('contact-records-btn').addEventListener('click', () => {
                document.getElementById('contact-records-btn').className = 'mr-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                document.getElementById('product-records-btn').className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
                document.getElementById('contact-records-container').classList.remove('hidden');
                document.getElementById('product-records-container').classList.add('hidden');
            });
            
            // 为筛选下拉框添加事件监听器，传递筛选参数
            document.getElementById('product-filter').addEventListener('change', (e) => {
                const productFilterValue = e.target.value;
                const customerId = customer.id;
                // 获取当前联系筛选器的值
                const contactFilterElement = document.getElementById('contact-filter');
                const contactFilterValue = contactFilterElement ? contactFilterElement.value : 'all';
                showCustomerDetail(customerId, productFilterValue, contactFilterValue);
            });
            
            document.getElementById('contact-filter').addEventListener('change', (e) => {
                const contactFilterValue = e.target.value;
                const customerId = customer.id;
                // 获取当前产品筛选器的值
                const productFilterElement = document.getElementById('product-filter');
                const productFilterValue = productFilterElement ? productFilterElement.value : 'all';
                showCustomerDetail(customerId, productFilterValue, contactFilterValue);
            });
        }

        // 编辑客户
        function editCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);

            if (!customer) return;
            
            document.getElementById('edit-customer-id').value = customer.id;
            document.getElementById('edit-customer-name').value = customer.name;
            document.getElementById('edit-customer-phone').value = customer.phone;
            document.getElementById('edit-customer-wechat').value = customer.wechat || '';
            document.getElementById('edit-customer-identity').value = customer.identity || '';
            document.getElementById('edit-customer-owner').value = customer.owner;
            document.getElementById('edit-customer-due-date').value = customer.dueDate || '';
            document.getElementById('edit-customer-status').value = customer.status;
            document.getElementById('edit-customer-allergic').value = customer.allergic;
            document.getElementById('edit-customer-allergy-info').value = customer.allergyInfo || '';
            
            // 宝宝信息
            const container = document.getElementById('edit-babies-container');
            container.innerHTML = '';
            
            if (customer.babies && customer.babies.length > 0) {
                customer.babies.forEach((baby, index) => {
                    const form = document.createElement('div');
                    form.className = 'baby-form grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 border border-dashed border-gray-300 rounded-lg';
                    form.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">宝宝姓名 *</label>
                            <input type="text" class="edit-baby-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required value="${baby.name || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">出生日期</label>
                            <input type="date" class="edit-baby-birthdate w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="${baby.birthDate || ''}">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">或通过年龄计算</label>
                            <div class="flex space-x-2">
                                <input type="number" class="edit-baby-age-years w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="岁">
                                <input type="number" class="edit-baby-age-months w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="月">
                                <button type="button" onclick="calculateEditBirthdate(this)" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                    <i class="fa fa-calculator"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">性别</label>
                            <select class="edit-baby-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">请选择</option>
                                <option value="男" ${baby.gender === '男' ? 'selected' : ''}>男</option>
                                <option value="女" ${baby.gender === '女' ? 'selected' : ''}>女</option>
                            </select>
                        </div>
                        <div class="md:col-span-5">
                            <button type="button" onclick="removeEditBabyForm(this)" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                <i class="fa fa-trash mr-2"></i>删除
                            </button>
                        </div>
                    `;
                    container.appendChild(form);
                });
            } else {
                // 添加一个空的宝宝表单
                addEditBabyForm();
            }
            
            // 过敏信息显示
            if (customer.allergic === '是') {
                document.getElementById('edit-allergy-info-container').classList.remove('hidden');
            } else {
                document.getElementById('edit-allergy-info-container').classList.add('hidden');
            }
            
    // 先关闭客户详情模态框
    closeModal('customer-detail-modal');

            showModal('edit-customer-modal');
        }

        // 添加编辑宝宝表单
        function addEditBabyForm() {
            const container = document.getElementById('edit-babies-container');
            const newForm = document.createElement('div');
            newForm.className = 'baby-form grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 border border-dashed border-gray-300 rounded-lg';
            newForm.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">宝宝姓名 *</label>
                    <input type="text" class="edit-baby-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">出生日期</label>
                    <input type="date" class="edit-baby-birthdate w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">或通过年龄计算</label>
                    <div class="flex space-x-2">
                        <input type="number" class="edit-baby-age-years w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="岁">
                        <input type="number" class="edit-baby-age-months w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="月">
                        <button type="button" onclick="calculateEditBirthdate(this)" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fa fa-calculator"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">性别</label>
                    <select class="edit-baby-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">请选择</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </div>
                <div class="md:col-span-5">
                    <button type="button" onclick="removeEditBabyForm(this)" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fa fa-trash mr-2"></i>删除
                    </button>
                </div>
            `;
            container.appendChild(newForm);
        }

        // 移除编辑宝宝表单
        function removeEditBabyForm(button) {
            const form = button.closest('.baby-form');
            const container = document.getElementById('edit-babies-container');
            
            if (container.children.length > 1) {
                form.remove();
            } else {
                showNotification('至少需要保留一个宝宝信息！', 'warning');
            }
        }

        // 切换编辑过敏信息显示
        function toggleEditAllergyInfo() {
            const allergic = document.getElementById('edit-customer-allergic').value;
            const container = document.getElementById('edit-allergy-info-container');
            
            if (allergic === '是') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // 根据年龄计算出生日期（编辑模式）
        function calculateEditBirthdate(button) {
            const form = button.closest('.baby-form');
            const years = parseInt(form.querySelector('.edit-baby-age-years').value) || 0;
            const months = parseInt(form.querySelector('.edit-baby-age-months').value) || 0;
            
            if (years === 0 && months === 0) {
                showNotification('请输入年龄或月龄！', 'warning');
                return;
            }
            
            const birthDate = new Date();
            birthDate.setFullYear(birthDate.getFullYear() - years);
            birthDate.setMonth(birthDate.getMonth() - months);
            
            // 格式化为YYYY-MM-DD
            const formattedDate = birthDate.toISOString().split('T')[0];
            form.querySelector('.edit-baby-birthdate').value = formattedDate;
            
            showNotification('出生日期已计算完成！', 'success');
        }

        // 更新客户信息
        function updateCustomer(event) {
            event.preventDefault();
            
            const customerId = parseInt(document.getElementById('edit-customer-id').value);
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) return;
            
            customer.name = document.getElementById('edit-customer-name').value;
            customer.phone = document.getElementById('edit-customer-phone').value;
            customer.wechat = document.getElementById('edit-customer-wechat').value;
            customer.identity = document.getElementById('edit-customer-identity').value;
            customer.owner = document.getElementById('edit-customer-owner').value;
            customer.dueDate = document.getElementById('edit-customer-due-date').value;
            customer.status = document.getElementById('edit-customer-status').value;
            customer.allergic = document.getElementById('edit-customer-allergic').value;
            customer.allergyInfo = document.getElementById('edit-customer-allergy-info').value;
            customer.updatedAt = new Date().toISOString();
            
            // 更新宝宝信息
            customer.babies = [];
            const babyForms = document.querySelectorAll('#edit-babies-container .baby-form');
            babyForms.forEach(form => {
                const name = form.querySelector('.edit-baby-name').value;
                if (name) {
                    customer.babies.push({
                        name: name,
                        birthDate: form.querySelector('.edit-baby-birthdate').value,
                        gender: form.querySelector('.edit-baby-gender').value
                    });
                }
            });
            
            saveData();
            closeModal('edit-customer-modal');
            updateDashboard();
            updateCustomerList();
            updateOwnerFilter();
            
            // 刷新客户详情页面（如果打开）
            const detailModal = document.getElementById('customer-detail-modal');
            if (!detailModal.classList.contains('hidden') && detailModal.dataset.customerId == customerId) {
                showCustomerDetail(customerId);
            }
            
            // 显示成功消息
            showNotification('客户信息更新成功！', 'success');
        }

        // 删除客户
        function deleteCustomer() {
            if (!customerToDelete) return;
            
            if (confirm('确定要删除这个客户吗？此操作将删除客户的所有信息，且无法恢复！')) {
                // 删除客户相关的寄存记录
                storageRecords = storageRecords.filter(record => record.customerId !== customerToDelete);
                
                // 删除客户
                customers = customers.filter(customer => customer.id !== customerToDelete);
                
                saveData();
                closeModal('customer-detail-modal');
                updateDashboard();
                updateCustomerList();
                updateOwnerFilter();
                updateStorageManagementList();
                
                // 显示成功消息
                showNotification('客户删除成功！', 'success');
            }
        }

        // 显示添加产品模态框
        function showAddProductModal() {
            document.getElementById('add-product-form').reset();
            document.getElementById('milk-form').classList.add('hidden');
            document.getElementById('diaper-form').classList.add('hidden');
            document.getElementById('nutrition-form').classList.add('hidden');
            
            // 清空产品客户选择下拉框
            const select = document.getElementById('product-customer-select');
            select.innerHTML = '<option value="">请选择客户</option>';
            
            // 填充客户选择下拉框
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.phone})`;
                select.appendChild(option);
            });
            
            showModal('add-product-modal');
        }

        // 为指定客户显示添加产品模态框
        function showAddProductModalForCustomer(customerId) {
            showAddProductModal();
            
            // 设置默认客户
            setTimeout(() => {
                const select = document.getElementById('product-customer-select');
                select.value = customerId;
                loadCustomerProducts();
            }, 100);
        }

        // 显示产品表单
        function showProductForm() {
            const productType = document.getElementById('product-type').value;
            
            // 隐藏所有表单
            document.getElementById('milk-form').classList.add('hidden');
            document.getElementById('diaper-form').classList.add('hidden');
            document.getElementById('nutrition-form').classList.add('hidden');
            
            // 显示选中的表单
            if (productType === 'milk') {
                document.getElementById('milk-form').classList.remove('hidden');
                // 设置默认值
                document.getElementById('new-milk-spoon-weight').value = 4.3;
                document.getElementById('new-milk-date').value = new Date().toISOString().split('T')[0];
            } else if (productType === 'diaper') {
                document.getElementById('diaper-form').classList.remove('hidden');
                document.getElementById('new-diaper-date').value = new Date().toISOString().split('T')[0];
            } else if (productType === 'nutrition') {
                document.getElementById('nutrition-form').classList.remove('hidden');
                document.getElementById('new-nutrition-date').value = new Date().toISOString().split('T')[0];
                // 显示回访提醒设置
                document.getElementById('nutrition-reminder-container').classList.remove('hidden');
                // 初始化显示正确的用量输入字段
                toggleNutritionFields();
            }
        }

        // 切换营养品字段显示
        function toggleNutritionFields() {
            const nutritionType = document.getElementById('new-nutrition-type').value;
            
            if (nutritionType === 'recommended') {
                document.getElementById('daily-amount-container').classList.add('hidden');
                document.getElementById('recommended-container').classList.remove('hidden');
            } else {
                document.getElementById('daily-amount-container').classList.remove('hidden');
                document.getElementById('recommended-container').classList.add('hidden');
            }
        }

        // 切换寄存数量输入框显示
        function toggleStorageQuantity(productType) {
            const checkbox = document.getElementById(`new-${productType}-storage`);
            const container = document.getElementById(`new-${productType}-storage-quantity-container`);
            
            if (checkbox.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // 计算结束日期
        function calculateEndDate() {
            const productType = document.getElementById('product-type').value;
            
            if (productType === 'milk') {
                calculateMilkEndDate();
            } else if (productType === 'diaper') {
                calculateDiaperEndDate();
            } else if (productType === 'nutrition') {
                calculateNutritionEndDate();
            }
        }

        // 计算奶粉结束日期
        function calculateMilkEndDate() {
            const weight = parseFloat(document.getElementById('new-milk-weight').value);
            const purchaseQuantity = parseInt(document.getElementById('new-milk-purchase-quantity').value);
            const takeQuantity = parseInt(document.getElementById('new-milk-take-quantity').value);
            const water = parseInt(document.getElementById('new-milk-water').value);
            const spoonWeight = parseFloat(document.getElementById('new-milk-spoon-weight').value);
            const dailyMl = parseFloat(document.getElementById('new-milk-daily-grams').value);
            const date = document.getElementById('new-milk-date').value;
            
            if (!weight || !purchaseQuantity || !takeQuantity || !water || !spoonWeight || !dailyMl || !date) {
                document.getElementById('new-milk-end-date').value = '';
                return;
            }
            
            // 计算实际每日奶粉用量：(每日奶量毫升 / 每勺加水量) * 每勺奶粉重量
            const dailyMilkUsage = (dailyMl / water) * spoonWeight;
            
            // 使用拿走的数量计算预计用完时间
            const totalWeight = weight * takeQuantity;
            const days = Math.floor(totalWeight / dailyMilkUsage);
            
            const endDate = new Date(date);
            endDate.setDate(endDate.getDate() + days);
            
            document.getElementById('new-milk-end-date').value = endDate.toISOString().split('T')[0];
        }

        // 计算尿不湿结束日期
        function calculateDiaperEndDate() {
            const purchaseQuantity = parseInt(document.getElementById('new-diaper-purchase-quantity').value);
            const takeQuantity = parseInt(document.getElementById('new-diaper-take-quantity').value);
            const date = document.getElementById('new-diaper-date').value;
            
            if (!purchaseQuantity || !takeQuantity || !date) {
                document.getElementById('new-diaper-end-date').value = '';
                return;
            }
            
            // 根据用户需求改为一周一包
            const daysPerPackage = 7;
            const totalDays = takeQuantity * daysPerPackage;
            
            const endDate = new Date(date);
            endDate.setDate(endDate.getDate() + totalDays);
            
            document.getElementById('new-diaper-end-date').value = endDate.toISOString().split('T')[0];
        }

        // 计算营养品结束日期
        function calculateNutritionEndDate() {
            const purchaseQuantity = parseInt(document.getElementById('new-nutrition-purchase-quantity').value);
            const takeQuantity = parseInt(document.getElementById('new-nutrition-take-quantity').value);
            const nutritionType = document.getElementById('new-nutrition-type').value;
            // 根据不同的用量类型获取对应的每日使用量
            const dailyAmount = nutritionType === 'daily' 
                ? parseFloat(document.getElementById('new-nutrition-daily').value)
                : parseFloat(document.getElementById('new-nutrition-recommended').value);
            const date = document.getElementById('new-nutrition-date').value;
            
            if (!purchaseQuantity || !takeQuantity || !dailyAmount || !date) {
                document.getElementById('new-nutrition-end-date').value = '';
                return;
            }
            
            // 使用拿走的数量计算预计用完时间（假设每包是单位数量）
            const totalAmount = takeQuantity;
            const days = Math.floor(totalAmount / dailyAmount);
            
            const endDate = new Date(date);
            endDate.setDate(endDate.getDate() + days);
            
            document.getElementById('new-nutrition-end-date').value = endDate.toISOString().split('T')[0];
        }

        // 保存产品记录
        function saveProductFromButton() {
            const customerId = parseInt(document.getElementById('product-customer-select').value);
            const productType = document.getElementById('product-type').value;
            
            if (!customerId || !productType) {
                showNotification('请选择客户和产品类型！', 'warning');
                return;
            }
            
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('客户不存在！', 'error');
                return;
            }
            
            let product = null;
            
            if (productType === 'milk') {
                product = createMilkProduct();
            } else if (productType === 'diaper') {
                product = createDiaperProduct();
            } else if (productType === 'nutrition') {
                product = createNutritionProduct();
            }
            
            if (!product) {
                showNotification('请填写完整的产品信息！', 'warning');
                return;
            }
            
            // 添加产品到客户
            if (!customer.products) {
                customer.products = [];
            }
            
            customer.products.push(product);
            customer.updatedAt = new Date().toISOString();
            
            // 处理寄存
            const needStorage = document.getElementById(`new-${productType}-storage`).checked;
            if (needStorage) {
                const storageQuantity = parseInt(document.getElementById(`new-${productType}-storage-quantity`).value) || 0;
                if (storageQuantity > 0) {
                    createStorageRecord(customerId, product, storageQuantity);
                }
            }
            
            saveData();
            closeModal('add-product-modal');
            updateDashboard();
            updateCustomerList();
            updateStorageManagementList();
            
            // 显示成功消息
            showNotification('产品记录添加成功！', 'success');
        }

        // 创建奶粉产品
        function createMilkProduct() {
            const name = document.getElementById('new-milk-name').value;
            const brand = document.getElementById('new-milk-brand').value;
            const weight = parseFloat(document.getElementById('new-milk-weight').value);
            const purchaseQuantity = parseInt(document.getElementById('new-milk-purchase-quantity').value);
            const takeQuantity = parseInt(document.getElementById('new-milk-take-quantity').value);
            const spoonWeight = parseFloat(document.getElementById('new-milk-spoon-weight').value);
            const water = parseInt(document.getElementById('new-milk-water').value);
            const dailyMl = parseFloat(document.getElementById('new-milk-daily-grams').value);
            const date = document.getElementById('new-milk-date').value;
            const endDate = document.getElementById('new-milk-end-date').value;
            const needStorage = document.getElementById('new-milk-storage').checked;
            const storageQuantity = parseInt(document.getElementById('new-milk-storage-quantity').value) || 0;
            
            if (!name || !brand || !weight || !purchaseQuantity || !takeQuantity || !spoonWeight || !water || !dailyMl || !date || !endDate) {
                return null;
            }
            
            const price = parseFloat(document.getElementById('new-milk-price').value) || 0;
            const totalPrice = parseFloat(document.getElementById('new-milk-total-price').value) || 0;
            
            return {
                id: Date.now(),
                type: 'milk',
                name: name,
                brand: brand,
                weight: weight,
                purchaseQuantity: purchaseQuantity,
                takeQuantity: takeQuantity,
                spoonWeight: spoonWeight,
                water: water,
                dailyMl: dailyMl,
                date: date,
                endDate: endDate,
                needStorage: needStorage,
                storageQuantity: storageQuantity,
                price: price,
                totalPrice: totalPrice,
                createdAt: new Date().toISOString()
            };
        }

        // 创建尿不湿产品
        function createDiaperProduct() {
            const name = document.getElementById('new-diaper-name').value;
            const size = document.getElementById('new-diaper-size').value;
            const purchaseQuantity = parseInt(document.getElementById('new-diaper-purchase-quantity').value);
            const takeQuantity = parseInt(document.getElementById('new-diaper-take-quantity').value);
            const date = document.getElementById('new-diaper-date').value;
            const endDate = document.getElementById('new-diaper-end-date').value;
            const needStorage = document.getElementById('new-diaper-storage').checked;
            const storageQuantity = parseInt(document.getElementById('new-diaper-storage-quantity').value) || 0;
            
            if (!name || !size || !purchaseQuantity || !takeQuantity || !date || !endDate) {
                return null;
            }
            
            const price = parseFloat(document.getElementById('new-diaper-price').value) || 0;
            const totalPrice = parseFloat(document.getElementById('new-diaper-total-price').value) || 0;
            
            return {
                id: Date.now(),
                type: 'diaper',
                name: name,
                size: size,
                purchaseQuantity: purchaseQuantity,
                takeQuantity: takeQuantity,
                date: date,
                endDate: endDate,
                needStorage: needStorage,
                storageQuantity: storageQuantity,
                price: price,
                totalPrice: totalPrice,
                createdAt: new Date().toISOString()
            };
        }

        // 创建营养品产品
        function createNutritionProduct() {
            const name = document.getElementById('new-nutrition-name').value;
            const brand = document.getElementById('new-nutrition-brand').value;
            const nutritionType = document.getElementById('new-nutrition-type').value;
            // 根据不同的用量类型获取对应的每日使用量
            const dailyAmount = nutritionType === 'daily' 
                ? parseFloat(document.getElementById('new-nutrition-daily').value)
                : parseFloat(document.getElementById('new-nutrition-recommended').value);
            const purchaseQuantity = parseInt(document.getElementById('new-nutrition-purchase-quantity').value);
            const takeQuantity = parseInt(document.getElementById('new-nutrition-take-quantity').value);
            const date = document.getElementById('new-nutrition-date').value;
            const endDate = document.getElementById('new-nutrition-end-date').value;
            const needStorage = document.getElementById('new-nutrition-storage').checked;
            const storageQuantity = parseInt(document.getElementById('new-nutrition-storage-quantity').value) || 0;
            // 检查回访提醒元素是否存在
            const reminder = document.getElementById('nutrition-reminder') ? document.getElementById('nutrition-reminder').checked : false;
            
            if (!name || !brand || !nutritionType || !dailyAmount || !purchaseQuantity || !takeQuantity || !date || !endDate) {
                return null;
            }
            
            const price = parseFloat(document.getElementById('new-nutrition-price').value) || 0;
            const totalPrice = parseFloat(document.getElementById('new-nutrition-total-price').value) || 0;
            
            const product = {
                id: Date.now(),
                type: 'nutrition',
                name: name,
                brand: brand,
                nutritionType: nutritionType,
                purchaseQuantity: purchaseQuantity,
                takeQuantity: takeQuantity,
                date: date,
                price: price,
                totalPrice: totalPrice,
                endDate: endDate,
                needStorage: needStorage,
                storageQuantity: storageQuantity,
                createdAt: new Date().toISOString()
            };
            
            if (nutritionType === 'daily') {
                product.dailyAmount = dailyAmount;
            } else {
                product.recommendedAmount = dailyAmount;
            }
            
            // 如果需要回访提醒，创建提醒记录
            if (reminder) {
                // 从saveProductFromButton函数中获取customerId
                const customerId = parseInt(document.getElementById('product-customer-select').value);
                createNutritionReminders(product.id, customerId, date);
            }
            
            return product;
        }

        // 创建营养品回访提醒
        function createNutritionReminders(productId, customerId, startDate) {
            const start = new Date(startDate);
            const reminders = [];
            
            // 前三天每天提醒
            for (let i = 1; i <= 3; i++) {
                const reminderDate = new Date(start);
                reminderDate.setDate(start.getDate() + i);
                reminders.push({
                    id: Date.now() + i,
                    type: 'nutrition',
                    productId: productId,
                    customerId: customerId,
                    date: reminderDate.toISOString().split('T')[0],
                    title: '营养品使用回访',
                    completed: false
                });
            }
            
            // 第四天开始每三天提醒一次（到第10天）
            for (let i = 4; i <= 10; i += 3) {
                const reminderDate = new Date(start);
                reminderDate.setDate(start.getDate() + i);
                reminders.push({
                    id: Date.now() + i,
                    type: 'nutrition',
                    productId: productId,
                    customerId: customerId,
                    date: reminderDate.toISOString().split('T')[0],
                    title: '营养品使用回访',
                    completed: false
                });
            }
            
            // 一周后（第14天）开始每周提醒一次
            for (let i = 14; i <= 30; i += 7) {
                const reminderDate = new Date(start);
                reminderDate.setDate(start.getDate() + i);
                reminders.push({
                    id: Date.now() + i + 100,
                    type: 'nutrition',
                    productId: productId,
                    customerId: customerId,
                    date: reminderDate.toISOString().split('T')[0],
                    title: '营养品使用回访',
                    completed: false
                });
            }
            
            // 将提醒添加到客户的联系记录中
            const customer = customers.find(c => c.id === customerId);
            if (customer && customer.contacts) {
                reminders.forEach(reminder => {
                    customer.contacts.push({
                        id: reminder.id,
                        type: 'reminder',
                        method: '回访提醒',
                        result: '待处理',
                        remark: reminder.title,
                        date: reminder.date,
                        nextContactDate: null
                    });
                });
            }
        }

        // 创建寄存记录
        function createStorageRecord(customerId, product, quantity) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const storageRecord = {
                id: Date.now(),
                customerId: customerId,
                customerName: customer.name,
                productName: product.name,
                brand: product.brand || '',
                type: product.type,
                quantity: quantity,
                takeQuantity: product.takeQuantity,
                remainingQuantity: quantity,
                storageDate: new Date().toISOString().split('T')[0],
                note: '',
                pickups: [],
                expectedPickupDates: []
            };
            
            // 根据产品类型添加相关参数
            if (product.type === 'milkPowder') {
                storageRecord.scoopGram = product.scoopGram;
                storageRecord.scoopWater = product.scoopWater;
                storageRecord.canGram = product.canGram;
                storageRecord.dailyScoops = product.dailyScoops;
            } else if (product.type === 'diaper') {
                storageRecord.size = product.size;
            } else if (product.type === 'nutrition') {
                storageRecord.dailyAmount = product.dailyAmount;
            }
            
            // 计算预计取货日期
            calculateExpectedPickupDates(storageRecord, product.takeQuantity);
            
            storageRecords.push(storageRecord);
        }

        // 显示添加联系记录模态框
        function showAddContactModalForCustomer(customerId) {
            document.getElementById('contact-record-form').reset();
            document.getElementById('contact-customer-id').value = customerId;
            
            // 设置默认日期为今天
            document.getElementById('next-contact-date').value = new Date().toISOString().split('T')[0];
            
            showModal('add-contact-modal');
        }

        // 计算预计取货日期
        function calculateExpectedPickupDates(storageRecord, takeQuantity) {
            // 验证参数
            if (!storageRecord || !takeQuantity || isNaN(takeQuantity) || takeQuantity <= 0) {
                storageRecord.expectedPickupDates = [];
                return;
            }
            
            // 验证产品类型
            const validTypes = ['milkPowder', 'diaper', 'nutrition'];
            if (!validTypes.includes(storageRecord.type)) {
                storageRecord.expectedPickupDates = [];
                return;
            }
            
            // 确定计算起始日期：如果有取货记录，使用最后一次取货日期；否则使用寄存日期
            let currentDate;
            if (storageRecord.pickups && storageRecord.pickups.length > 0) {
                // 按日期排序取货记录
                const sortedPickups = [...storageRecord.pickups].sort((a, b) => new Date(a.date) - new Date(b.date));
                // 使用最后一次取货日期
                currentDate = new Date(sortedPickups[sortedPickups.length - 1].date);
            } else {
                // 使用寄存日期
                currentDate = new Date(storageRecord.storageDate);
            }
            const expectedDates = [];
            
            // 根据产品类型计算每次取货的间隔天数
            let daysPerTake;
            
            if (storageRecord.type === 'milkPowder') {
                // 奶粉：每天使用scoopGram * dailyScoops克
                // 每罐canGram克，所以每罐使用天数：canGram / (scoopGram * dailyScoops)
                // 取takeQuantity罐的使用天数：每罐使用天数 * takeQuantity
                if (storageRecord.scoopGram && storageRecord.dailyScoops && storageRecord.canGram) {
                    const dailyGram = storageRecord.scoopGram * storageRecord.dailyScoops;
                    const daysPerCan = storageRecord.canGram / dailyGram;
                    daysPerTake = daysPerCan * takeQuantity;
                } else {
                    // 缺少必要参数，无法计算预计取货时间
                    storageRecord.expectedPickupDates = [];
                    return;
                }
            } else if (storageRecord.type === 'diaper') {
                // 尿不湿：每周一包，取takeQuantity包的使用天数：7天 * takeQuantity
                daysPerTake = 7 * takeQuantity;
            } else if (storageRecord.type === 'nutrition') {
                // 营养品：每天使用dailyAmount，takeQuantity是每次拿走的数量
                if (storageRecord.dailyAmount) {
                    daysPerTake = takeQuantity / storageRecord.dailyAmount;
                } else {
                    // 缺少必要参数，无法计算预计取货时间
                    storageRecord.expectedPickupDates = [];
                    return;
                }
            } else {
                // 未知产品类型，无法计算预计取货时间
                storageRecord.expectedPickupDates = [];
                return;
            }
            
            // 确保daysPerTake至少为1天
            daysPerTake = Math.max(1, Math.round(daysPerTake));
            
            // 计算下一次预计取货日期：当前存货预计用完的日期
            let nextDate = new Date(currentDate);
            nextDate.setDate(nextDate.getDate() + daysPerTake);
            expectedDates.push(nextDate.toISOString().split('T')[0]);
            
            // 保存预计取货日期（仅显示下一次）
            storageRecord.expectedPickupDates = expectedDates;
        }

        // 保存联系记录
        function saveContactRecord(event) {
            event.preventDefault();
            
            const customerId = parseInt(document.getElementById('contact-customer-id').value);
            const method = document.getElementById('contact-method').value;
            const result = document.getElementById('contact-result').value;
            const remark = document.getElementById('contact-remark').value;
            const nextContactDate = document.getElementById('next-contact-date').value;
            
            if (!customerId || !method || !result) {
                showNotification('请填写完整的联系信息！', 'warning');
                return;
            }
            
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('客户不存在！', 'error');
                return;
            }
            
            const contactRecord = {
                id: Date.now(),
                method: method,
                result: result,
                remark: remark,
                date: new Date().toISOString().split('T')[0],
                nextContactDate: nextContactDate
            };
            
            if (!customer.contacts) {
                customer.contacts = [];
            }
            
            customer.contacts.push(contactRecord);
            customer.updatedAt = new Date().toISOString();
            
            saveData();
            closeModal('add-contact-modal');
            updateDashboard();
            updateCustomerList();
            
            // 刷新客户详情页面（如果打开）
            const detailModal = document.getElementById('customer-detail-modal');
            if (!detailModal.classList.contains('hidden') && detailModal.dataset.customerId == customerId) {
                showCustomerDetail(customerId);
            }
            
            // 显示成功消息
            showNotification('联系记录添加成功！', 'success');
        }

        // 更新仪表板数据
        function updateDashboard() {
            const totalCustomers = customers.length;
            const totalBabies = customers.reduce((sum, customer) => sum + (customer.babies ? customer.babies.length : 0), 0);
            const nutritionCustomers = customers.filter(customer => 
                customer.products && customer.products.some(product => product.type === 'nutrition')
            ).length;
            
            // 计算待回访客户数
            const followUpCustomers = customers.filter(customer => 
                customer.contacts && customer.contacts.some(contact => 
                    contact.result === '需要回访' && (!contact.nextContactDate || new Date(contact.nextContactDate) <= new Date())
                )
            ).length;
            
            // 计算当月预产期客户数
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const dueDateCustomers = customers.filter(customer => 
                customer.dueDate && 
                new Date(customer.dueDate).getMonth() === currentMonth && 
                new Date(customer.dueDate).getFullYear() === currentYear
            ).length;
            
            // 更新今日提醒数
            const today = new Date().toISOString().split('T')[0];
            let todayReminders = 0;
            
            customers.forEach(customer => {
                // 产品到期提醒
                if (customer.products) {
                    customer.products.forEach(product => {
                        if (product.endDate) {
                            const endDate = new Date(product.endDate);
                            const todayDate = new Date(today);
                            const daysDiff = Math.ceil((endDate - todayDate) / (1000 * 60 * 60 * 24));
                            
                            if (daysDiff >= 0 && daysDiff <= settings.reminderDays) {
                                todayReminders++;
                            }
                        }
                    });
                }
                
                // 联系记录提醒
                if (customer.contacts) {
                    customer.contacts.forEach(contact => {
                        if (contact.nextContactDate && contact.nextContactDate === today) {
                            todayReminders++;
                        }
                    });
                }
                
                // 预产期提醒（提前30天）
                if (customer.dueDate) {
                    const dueDate = new Date(customer.dueDate);
                    const daysDiff = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysDiff >= 0 && daysDiff <= 30) {
                        todayReminders++;
                    }
                }
            });
            
            // 更新显示
            document.getElementById('total-customers').textContent = totalCustomers;
            document.getElementById('today-reminders').textContent = todayReminders;
            document.getElementById('total-babies').textContent = totalBabies;
            document.getElementById('nutrition-customers').textContent = nutritionCustomers;
            document.getElementById('due-date-customers').textContent = dueDateCustomers;
            document.getElementById('follow-up-customers').textContent = followUpCustomers;
        }

        // 更新今日提醒列表
        function updateTodayReminders() {
            const list = document.getElementById('today-reminders-list');
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const reminders = [];
            const REMINDER_ADVANCE_DAYS = 7;
            
            // 检查已完成提醒，只保留今天完成的提醒，明天自动清理
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (!localStorage.motherBabyReminderCompletionDates) {
                localStorage.motherBabyReminderCompletionDates = JSON.stringify({});
            }
            const completionDates = JSON.parse(localStorage.motherBabyReminderCompletionDates);
            window.completionDates = completionDates; // 保存到全局变量以便在markReminderAsCompleted函数中使用
            
            // 只保留今天完成的提醒
            const todayCompletedReminders = completedReminders.filter(reminderId => {
                return completionDates[reminderId] === today;
            });
            
            if (todayCompletedReminders.length !== completedReminders.length) {
                completedReminders = todayCompletedReminders;
                saveData();
            }
            
            customers.forEach(customer => {
                // 1. 产品到期提醒 - 提前7天提醒
                if (customer.products) {
                    customer.products.forEach(product => {
                        if (product.endDate) {
                            const endDate = new Date(product.endDate);
                            const todayDate = new Date(today);
                            const daysLeft = Math.ceil((endDate - todayDate) / (1000 * 60 * 60 * 24));
                            const reminderId = `product-${product.id}`;
                            const isCompleted = completedReminders.includes(reminderId);
                            
                            // 提前7天提醒，包括当天
                            if ((!isCompleted && daysLeft >= 0 && daysLeft <= REMINDER_ADVANCE_DAYS) || 
                                (isCompleted && completionDates[reminderId] === today)) {
                                reminders.push({
                                    id: reminderId,
                                    type: 'product',
                                    customer: customer,
                                    product: product,
                                    title: `${customer.name}的${getProductTypeName(product.type)}${daysLeft === 0 ? '今天过期' : '即将过期'}`,
                                    description: `${product.brand}${product.name}${daysLeft === 0 ? '今天过期' : `还有${daysLeft}天过期`}`,
                                    date: product.endDate,
                                    daysLeft: daysLeft
                                });
                            }
                        }
                    });
                }
                
                // 联系记录提醒
                if (customer.contacts) {
                    customer.contacts.forEach(contact => {
                        // 常规联系提醒 - 保留过期未完成的提醒
                        if (contact.nextContactDate) {
                            const contactDate = contact.nextContactDate.split('T')[0];
                            const reminderId = `contact-${contact.id}`;
                            const isCompleted = completedReminders.includes(reminderId);
                            const isToday = contactDate === today;
                            const isPast = contactDate < today;
                            
                            // 只显示今天的未完成提醒和今天完成的提醒
                            if ((!isCompleted && isToday) || (isCompleted && completionDates[reminderId] === today)) {
                                reminders.push({
                                    id: reminderId,
                                    type: 'contact',
                                    customer: customer,
                                    title: `需要联系${customer.name}`,
                                    description: `上次联系结果：${contact.result}${isPast ? '（已过期）' : ''}`,
                                    date: contact.nextContactDate,
                                    daysLeft: isToday ? 0 : isPast ? -1 : 1
                                });
                            }
                        }
                        
                        // 回访提醒 - 只显示今天或过期的未完成提醒，已完成提醒只显示当天
                        if (contact.type === 'follow_up_reminder') {
                            const contactDate = contact.date.split('T')[0];
                            const reminderId = `followup-${contact.id}`;
                            const isCompleted = completedReminders.includes(reminderId);
                            const isToday = contactDate === today;
                            const isPast = contactDate < today;
                            
                            // 显示条件：
                            // 1. 未完成的今天提醒
                            // 2. 已完成的今天提醒
                            if ((!isCompleted && isToday) || (isCompleted && completionDates[reminderId] === today)) {
                                reminders.push({
                                    id: reminderId,
                                    type: 'followup',
                                    customer: customer,
                                    title: `${customer.name}的定期回访提醒${isPast ? '（已过期）' : ''}`,
                                    description: contact.remark,
                                    date: contact.date,
                                    daysLeft: isToday ? 0 : isPast ? -1 : 1
                                });
                            }
                        }
                    });
                }
                
                // 预产期提醒 - 只在当月提醒
                if (customer.dueDate) {
                    const dueDate = new Date(customer.dueDate);
                    const todayDate = new Date();
                    const isCurrentMonth = dueDate.getFullYear() === todayDate.getFullYear() && dueDate.getMonth() === todayDate.getMonth();
                    const daysDiff = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                    const reminderId = `due-${customer.id}`;
                    const isCompleted = completedReminders.includes(reminderId);
                    
                    // 只显示当月未过期的未完成提醒和今天完成的提醒
                    if ((isCurrentMonth && !isCompleted && daysDiff >= 0) || (isCompleted && completionDates[reminderId] === today)) {
                        reminders.push({
                            id: reminderId,
                            type: 'due',
                            customer: customer,
                            title: `${customer.name}的预产期提醒${daysDiff < 0 ? '（已过期）' : ''}`,
                            description: `预产期${daysDiff === 0 ? '今天' : daysDiff > 0 ? `${daysDiff}天后` : `${Math.abs(daysDiff)}天前`}`,
                            date: customer.dueDate,
                            daysLeft: daysDiff
                        });
                    }
                }
            });
            
            // 寄存产品预计取货提醒
            storageRecords.forEach(record => {
                // 找到对应的客户
                const customer = customers.find(c => c.id === record.customerId);
                if (!customer) return; // 如果客户不存在，跳过
                
                // 遍历所有预计取货日期
                if (record.expectedPickupDates) {
                    record.expectedPickupDates.forEach(date => {
                        const pickupDate = new Date(date);
                        const todayDate = new Date(today);
                        const daysLeft = Math.ceil((pickupDate - todayDate) / (1000 * 60 * 60 * 24));
                        
                        // 只处理未来的提醒（包括今天）
                        if (daysLeft >= 0) {
                            // 生成唯一的提醒ID
                            const reminderId = `storage-${record.id}-${date}`;
                            const isCompleted = completedReminders.includes(reminderId);
                            
                            // 在预计取货日期前settings.reminderDays天提醒
                            if (daysLeft <= settings.reminderDays) {
                                reminders.push({
                                    id: reminderId,
                                    type: 'storage',
                                    customer: customer,
                                    title: `${customer.name}的寄存${record.productName}预计取货提醒`,
                                    description: `预计取货日期：${date}，还有${daysLeft}天`,
                                    date: date,
                                    daysLeft: daysLeft
                                });
                            }
                        }
                    });
                }
            });
            
            // 按剩余天数排序，今天的提醒显示在前面
            reminders.sort((a, b) => {
                // 对于都是未过期的提醒，按剩余天数排序
                if (a.daysLeft !== b.daysLeft) {
                    return a.daysLeft - b.daysLeft;
                }
                // 对于同一天的提醒，回访提醒优先显示
                if (a.type === 'followup' && b.type !== 'followup') {
                    return -1;
                }
                if (a.type !== 'followup' && b.type === 'followup') {
                    return 1;
                }
                // 最后按日期字符串排序以确保稳定性
                return a.date.localeCompare(b.date);
            });
            
            if (reminders.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">暂无今日提醒</p>';
                return;
            }
            
            // 将提醒均匀分配到3个区块，在大屏幕上显示为3列
            const chunks = [[], [], []];
            reminders.forEach((reminder, index) => {
                chunks[index % 3].push(reminder);
            });
            
            list.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    ${chunks.map(chunk => `
                        <div class="space-y-4">
                            ${chunk.map(reminder => {
                                const isCompleted = completedReminders.includes(reminder.id);
                                const reminderClass = isCompleted ? 'bg-gray-100 opacity-70' : reminder.daysLeft === 0 ? 'bg-red-50 border-red-200' : reminder.daysLeft <= 3 ? 'bg-orange-50 border-orange-200' : 'bg-blue-50 border-blue-200';
                                let iconClass;
                                if (reminder.type === 'product') iconClass = 'fa-shopping-cart';
                                else if (reminder.type === 'contact') iconClass = 'fa-phone';
                                else if (reminder.type === 'followup') iconClass = 'fa-comments';
                                else if (reminder.type === 'storage') iconClass = 'fa-archive';
                                else iconClass = 'fa-calendar';
                                
                                return `
                                    <div class="p-4 rounded-lg border ${reminderClass}" data-id="${reminder.id}">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex items-center space-x-3">
                                                <i class="fa ${iconClass} text-lg ${isCompleted ? 'text-gray-400' : reminder.daysLeft === 0 ? 'text-red-500' : reminder.daysLeft <= 3 ? 'text-orange-500' : 'text-blue-500'}"></i>
                                                <div>
                                                    <h4 class="font-medium ${isCompleted ? 'text-gray-600 line-through' : 'text-gray-900'}">${reminder.title}</h4>
                                                    <p class="text-sm text-gray-600">${reminder.description}</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="markReminderAsCompleted('${reminder.id}')" class="p-2 text-gray-400 hover:text-green-500 transition-colors">
                                                    <i class="fa ${isCompleted ? 'fa-check-circle text-green-500' : 'fa-circle-o'}"></i>
                                                </button>
                                                <button onclick="showCustomerDetail(${reminder.customer.id})" class="p-2 text-gray-400 hover:text-blue-500 transition-colors">
                                                    <i class="fa fa-info-circle"></i>
                                                </button>
                                                <button onclick="editReminder('${reminder.id}')" class="p-2 text-gray-400 hover:text-yellow-500 transition-colors">
                                                    <i class="fa fa-pencil"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `.trim();
                            }).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 更新历史提醒列表
        function updateHistoricalReminders() {
            const list = document.getElementById('historical-reminders-list');
            if (!list) return;
            
            const today = new Date().toISOString().split('T')[0];
            const historical = [];
            // 获取提醒完成日期记录
            const completionDates = JSON.parse(localStorage.getItem('motherBabyReminderCompletionDates') || '{}');
            
            customers.forEach(customer => {
                // 产品到期提醒 - 收集过期未完成的提醒
                if (customer.products) {
                    customer.products.forEach(product => {
                        if (product.endDate) {
                            const endDate = new Date(product.endDate);
                            const todayDate = new Date(today);
                            const reminderId = `product-${product.id}`;
                            const isCompleted = completionDates[reminderId] !== undefined;
                            
                            // 只显示过期未完成的提醒
                            if (endDate < todayDate && !isCompleted) {
                                historical.push({
                                    id: reminderId,
                                    type: 'product',
                                    customer: customer,
                                    title: `${customer.name}的${getProductTypeName(product.type)}已过期`,
                                    description: `${product.brand}${product.name}已于${endDate.toLocaleDateString()}过期`,
                                    date: product.endDate,
                                    daysLeft: Math.ceil((endDate - todayDate) / (1000 * 60 * 60 * 24))
                                });
                            }
                        }
                    });
                }
                
                // 联系记录提醒 - 收集过期未完成的提醒
                if (customer.contacts) {
                    customer.contacts.forEach(contact => {
                        if (contact.nextContactDate) {
                            const contactDate = new Date(contact.nextContactDate);
                            const todayDate = new Date(today);
                            const reminderId = `contact-${contact.id}`;
                            const isCompleted = completionDates[reminderId] !== undefined;
                            
                            // 只显示过期未完成的提醒
                            if (contactDate < todayDate && !isCompleted) {
                                historical.push({
                                    id: reminderId,
                                    type: 'contact',
                                    customer: customer,
                                    title: `需要联系${customer.name}（已过期）`,
                                    description: `上次联系结果：${contact.result}`,
                                    date: contact.nextContactDate,
                                    daysLeft: Math.ceil((contactDate - todayDate) / (1000 * 60 * 60 * 24))
                                });
                            }
                        }
                        
                        // 回访提醒 - 收集过期未完成的提醒
                        if (contact.type === 'follow_up_reminder') {
                            const contactDate = new Date(contact.date);
                            const todayDate = new Date(today);
                            const reminderId = `followup-${contact.id}`;
                            const isCompleted = completionDates[reminderId] !== undefined;
                            
                            // 显示过期未完成的提醒，以及今天完成的过期提醒
                            if (contactDate < todayDate && (!isCompleted || (isCompleted && completionDates[reminderId] === today))) {
                                historical.push({
                                    id: reminderId,
                                    type: 'followup',
                                    customer: customer,
                                    title: `${customer.name}的定期回访提醒（已过期）`,
                                    description: contact.remark,
                                    date: contact.date,
                                    daysLeft: Math.ceil((contactDate - todayDate) / (1000 * 60 * 60 * 24))
                                });
                            }
                        }
                    });
                }
                
                // 预产期提醒 - 收集过期未完成的提醒
                if (customer.dueDate) {
                    const dueDate = new Date(customer.dueDate);
                    const todayDate = new Date(today);
                    const reminderId = `due-${customer.id}`;
                    const isCompleted = completionDates[reminderId] !== undefined;
                            
                            // 只显示过期未完成的提醒
                            if (dueDate < todayDate && !isCompleted) {
                        historical.push({
                            id: reminderId,
                            type: 'due',
                            customer: customer,
                            title: `${customer.name}的预产期提醒（已过期）`,
                            description: `预产期${dueDate.toLocaleDateString()}`,
                            date: customer.dueDate,
                            daysLeft: Math.ceil((dueDate - todayDate) / (1000 * 60 * 60 * 24))
                        });
                    }
                }
            });
            
            // 寄存产品预计取货提醒 - 收集过期未完成的提醒
            storageRecords.forEach(record => {
                const customer = customers.find(c => c.id === record.customerId);
                if (!customer) return;
                
                if (record.expectedPickupDates) {
                    record.expectedPickupDates.forEach(date => {
                        const pickupDate = new Date(date);
                        const todayDate = new Date(today);
                        const reminderId = `storage-${record.id}-${date}`;
                        const isCompleted = completionDates[reminderId] !== undefined;
                            
                            // 只显示过期未完成的提醒
                            if (pickupDate < todayDate && !isCompleted) {
                            historical.push({
                                id: reminderId,
                                type: 'storage',
                                customer: customer,
                                title: `${customer.name}的寄存${record.productName}预计取货提醒（已过期）`,
                                description: `预计取货日期：${date}`,
                                date: date,
                                daysLeft: Math.ceil((pickupDate - todayDate) / (1000 * 60 * 60 * 24))
                            });
                        }
                    });
                }
            });
            
            // 按日期倒序排序，最新过期的显示在前面
            historical.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (historical.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">暂无历史提醒</p>';
                return;
            }
            
            list.innerHTML = historical.map(reminder => {
                const isCompleted = completionDates[reminder.id] !== undefined;
                const reminderClass = isCompleted ? 'bg-gray-100 opacity-70' : 'bg-yellow-50 border-yellow-200';
                let iconClass;
                if (reminder.type === 'product') iconClass = 'fa-shopping-cart';
                else if (reminder.type === 'contact') iconClass = 'fa-phone';
                else if (reminder.type === 'followup') iconClass = 'fa-comments';
                else if (reminder.type === 'storage') iconClass = 'fa-archive';
                else iconClass = 'fa-calendar';
                
                return `
                    <div class="p-4 rounded-lg border ${reminderClass}" data-id="${reminder.id}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-3">
                                <i class="fa ${iconClass} text-lg text-yellow-500"></i>
                                <div>
                                    <h4 class="font-medium text-gray-900">${reminder.title}</h4>
                                    <p class="text-sm text-gray-600">${reminder.description}</p>
                                    <p class="text-xs text-gray-400 mt-1">过期时间：${new Date(reminder.date).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="markReminderAsCompleted('${reminder.id}')" class="p-2 text-gray-400 hover:text-green-500 transition-colors">
                                    <i class="fa ${isCompleted ? 'fa-check-circle text-green-500' : 'fa-circle-o'}"></i>
                                </button>
                                <button onclick="showCustomerDetail(${reminder.customer.id})" class="p-2 text-gray-400 hover:text-blue-500 transition-colors">
                                    <i class="fa fa-info-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 生成客户回访计划
        function generateFollowUpPlan(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.followUpSettings || !customer.followUpSettings.enabled) {
                return;
            }
            
            if (!customer.contacts) {
                customer.contacts = [];
            }
            
            // 清除现有的回访提醒
            customer.contacts = customer.contacts.filter(contact => 
                contact.type !== 'follow_up_reminder'
            );
            
            const timesPerWeek = Math.min(Math.max(customer.followUpSettings.timesPerWeek, 1), 2); // 确保在1-2次范围内
            const startDate = new Date(customer.followUpSettings.nextFollowUpDate || new Date());
            const reminders = [];
            
            // 生成未来30天的回访计划
            for (let week = 0; week < 4; week++) { // 生成4周的计划
                // 对于每周回访次数，随机分配天数，但保持从远到近的顺序
                const daysInWeek = [];
                if (timesPerWeek === 1) {
                    // 每周随机选一天
                    daysInWeek.push(Math.floor(Math.random() * 7));
                } else {
                    // 每周随机选两天，且不相邻
                    let day1 = Math.floor(Math.random() * 7);
                    let day2;
                    do {
                        day2 = Math.floor(Math.random() * 7);
                    } while (Math.abs(day1 - day2) <= 1);
                    daysInWeek.push(Math.min(day1, day2), Math.max(day1, day2));
                }
                
                // 根据选定的天数生成回访日期
                daysInWeek.forEach(dayOffset => {
                    const reminderDate = new Date(startDate);
                    reminderDate.setDate(startDate.getDate() + (week * 7) + dayOffset);
                    
                    // 只生成未来的日期
                    if (reminderDate >= new Date()) {
                        reminders.push({
                            id: Date.now() + week * 10 + dayOffset,
                            type: 'follow_up_reminder',
                            method: '回访提醒',
                            result: '待处理',
                            remark: `客户定期回访`,
                            date: reminderDate.toISOString().split('T')[0],
                            nextContactDate: null
                        });
                    }
                });
            }
            
            // 按日期从远到近排序回访提醒
            reminders.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 将生成的回访提醒添加到客户的联系记录中
            customer.contacts.push(...reminders);
            
            // 更新下次回访日期为第一个提醒的日期
            if (reminders.length > 0) {
                customer.followUpSettings.nextFollowUpDate = reminders[0].date;
            }
        }

        // 标记提醒为已完成
        function markReminderAsCompleted(reminderId) {
            console.log('markReminderAsCompleted被调用，reminderId:', reminderId);
            
            // 立即给用户视觉反馈
            const reminderElement = document.querySelector(`[data-id="${reminderId}"]`);
            if (reminderElement) {
                // 添加临时高亮效果
                reminderElement.style.transition = 'all 0.3s ease';
                reminderElement.style.backgroundColor = '#e6f7ff';
                setTimeout(() => {
                    reminderElement.style.backgroundColor = '';
                }, 300);
            }
            
            console.log('调用前completedReminders:', completedReminders);
            const index = completedReminders.indexOf(reminderId);
            // 获取当前日期作为完成日期
            const todayStr = new Date().toISOString().split('T')[0];
            
            // 确保全局completionDates对象存在
            if (!window.completionDates) {
                // 如果不存在，从localStorage初始化
                if (!localStorage.motherBabyReminderCompletionDates) {
                    localStorage.motherBabyReminderCompletionDates = JSON.stringify({});
                }
                window.completionDates = JSON.parse(localStorage.motherBabyReminderCompletionDates);
            }
            const completionDates = window.completionDates;
            
            if (index === -1) {
                completedReminders.push(reminderId);
                // 保存完成日期
                completionDates[reminderId] = todayStr;
                console.log('添加到已完成列表并记录完成日期');
                // 直接更新DOM图标
                if (reminderElement) {
                    const iconElement = reminderElement.querySelector('button i.fa');
                    if (iconElement) {
                        iconElement.className = 'fa fa-check-circle text-green-500';
                    }
                    reminderElement.classList.add('bg-gray-100', 'opacity-70');
                    const titleElement = reminderElement.querySelector('h4');
                    if (titleElement) {
                        titleElement.classList.add('text-gray-600', 'line-through');
                    }
                }
            } else {
                completedReminders.splice(index, 1);
                // 移除完成日期记录
                delete completionDates[reminderId];
                console.log('从已完成列表移除并删除完成日期记录');
                // 直接更新DOM图标
                if (reminderElement) {
                    const iconElement = reminderElement.querySelector('button i.fa');
                    if (iconElement) {
                        iconElement.className = 'fa fa-circle-o';
                    }
                    reminderElement.classList.remove('bg-gray-100', 'opacity-70');
                    const titleElement = reminderElement.querySelector('h4');
                    if (titleElement) {
                        titleElement.classList.remove('text-gray-600', 'line-through');
                    }
                }
            }
            
            // 更新关联提醒的状态（联动功能）
            if (reminderId.startsWith('followup-')) {
                // 回访提醒
                const contactId = parseInt(reminderId.split('-')[1]);
                // 查找对应的联系人记录
                customers.forEach(customer => {
                    customer.contacts.forEach(contact => {
                        if (contact.id === contactId && contact.type === 'follow_up_reminder') {
                            // 更新联系人记录的状态
                            contact.result = index === -1 ? '已完成' : '待处理';
                            console.log('更新了回访提醒的状态:', contact.result);
                            return;
                        }
                    });
                });
            } else if (reminderId.startsWith('contact-')) {
                // 联系记录提醒
                const contactId = parseInt(reminderId.split('-')[1]);
                // 查找对应的联系人记录
                customers.forEach(customer => {
                    customer.contacts.forEach(contact => {
                        if (contact.id === contactId) {
                            // 更新联系人记录的状态
                            contact.result = index === -1 ? '已完成' : '需要回访';
                            console.log('更新了联系记录的状态:', contact.result);
                            return;
                        }
                    });
                });
            } else if (reminderId.startsWith('product-')) {
                // 产品到期提醒
                const productId = parseInt(reminderId.split('-')[1]);
                // 查找对应的产品记录
                customers.forEach(customer => {
                    if (customer.products) {
                        customer.products.forEach(product => {
                            if (product.id === productId) {
                                // 更新产品的状态
                                product.status = index === -1 ? '已完成' : '使用中';
                                console.log('更新了产品的状态:', product.status);
                                return;
                            }
                        });
                    }
                });
            } else if (reminderId.startsWith('due-')) {
                // 预产期提醒
                const customerId = parseInt(reminderId.split('-')[1]);
                // 查找对应的客户
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    // 更新客户的状态
                    customer.status = index === -1 ? '已完成' : customer.status;
                    console.log('更新了客户的状态:', customer.status);
                }
            } else if (reminderId.startsWith('storage-')) {
                // 寄存产品预计取货提醒
                const parts = reminderId.split('-');
                const storageId = parseInt(parts[1]);
                const pickupDate = parts[2];
                // 查找对应的寄存记录
                storageRecords.forEach(record => {
                    if (record.id === storageId) {
                        // 更新寄存记录的状态
                        record.status = index === -1 ? '已完成' : '待处理';
                        console.log('更新了寄存记录的状态:', record.status);
                        return;
                    }
                });
            }
            console.log('调用后completedReminders:', completedReminders);
            
            // 保存完成日期映射
            localStorage.motherBabyReminderCompletionDates = JSON.stringify(completionDates);
            
            saveData();
            updateDashboard();
            
            // 延迟更长时间后更新整个提醒列表，确保状态完全保存并同步
            setTimeout(() => {
                // 再次确认completedReminders数组已更新
                console.log('调用updateTodayReminders前的completedReminders:', completedReminders);
                updateTodayReminders();
                updateHistoricalReminders(); // 更新历史提醒
            }, 500);
        }

        // 过滤提醒
        function filterReminders() {
            const filter = document.getElementById('reminder-filter').value;
            const reminders = document.querySelectorAll('#today-reminders-list > div');
            
            reminders.forEach(reminder => {
                // 从data-id属性获取提醒ID
                const reminderId = reminder.getAttribute('data-id');
                // 直接从completedReminders数组判断状态，而不是依赖DOM类名
                const isCompleted = reminderId && completedReminders.includes(reminderId);
                
                if (filter === 'all') {
                    reminder.style.display = 'block';
                } else if (filter === 'completed' && isCompleted) {
                    reminder.style.display = 'block';
                } else if (filter === 'pending' && !isCompleted) {
                    reminder.style.display = 'block';
                } else {
                    reminder.style.display = 'none';
                }
            });
        }

        // 更新当月预产期列表
        function updateDueDateList() {
            const list = document.getElementById('due-date-list');
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const dueDateCustomers = customers.filter(customer => 
                customer.dueDate && 
                new Date(customer.dueDate).getMonth() === currentMonth && 
                new Date(customer.dueDate).getFullYear() === currentYear
            ).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            if (dueDateCustomers.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">当月暂无预产期客户</p>';
                return;
            }
            
            list.innerHTML = dueDateCustomers.map(customer => {
                const dueDate = new Date(customer.dueDate);
                const daysDiff = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                const statusClass = daysDiff <= 0 ? 'bg-red-100 text-red-800' : daysDiff <= 7 ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800';
                const statusText = daysDiff <= 0 ? '已到预产期' : daysDiff <= 7 ? '即将到预产期' : '预产期提醒';
                
                return `
                    <div class="p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-medium text-gray-900">${customer.name}</h4>
                                <p class="text-sm text-gray-600">${customer.phone} | ${customer.owner}</p>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-600">预产期：${formatDate(customer.dueDate)}</p>
                            <div class="flex space-x-2">
                                <button onclick="showCustomerDetail(${customer.id})" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    <i class="fa fa-info-circle mr-1"></i>详情
                                </button>
                                <button onclick="showAddContactModalForCustomer(${customer.id})" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition-colors text-sm">
                                    <i class="fa fa-phone mr-1"></i>联系
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 更新产品使用时间列表
        function updateProductUsageList() {
            const list = document.getElementById('product-usage-list');
            const products = [];
            
            customers.forEach(customer => {
                if (customer.products) {
                    customer.products.forEach(product => {
                        if (product.endDate) {
                            const endDate = new Date(product.endDate);
                            const today = new Date();
                            
                            // 只显示未过期的产品
                            if (endDate >= today) {
                                const daysLeft = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                                products.push({
                                    customer: customer,
                                    product: product,
                                    daysLeft: daysLeft
                                });
                            }
                        }
                    });
                }
            });
            
            // 按剩余天数排序
            products.sort((a, b) => a.daysLeft - b.daysLeft);
            
            if (products.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">暂无产品使用记录</p>';
                return;
            }
            
            list.innerHTML = products.slice(0, 10).map(item => {
                const statusClass = item.daysLeft <= 0 ? 'bg-red-100 text-red-800' : item.daysLeft <= 7 ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800';
                const statusText = item.daysLeft <= 0 ? '已过期' : item.daysLeft <= 7 ? '即将用完' : '使用中';
                
                return `
                    <div class="p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-medium text-gray-900">${item.customer.name}</h4>
                                <p class="text-sm text-gray-600">${item.product.brand}${item.product.name}</p>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600">预计用完：${formatDate(item.product.endDate)}</p>
                                <p class="text-sm text-gray-600">剩余：${item.daysLeft}天</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="showCustomerDetail(${item.customer.id})" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    <i class="fa fa-info-circle mr-1"></i>详情
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 显示统计模态框
        function showStatistics() {
            // 更新统计数据
            document.getElementById('stat-total-customers').textContent = customers.length;
            
            // 计算活跃客户数（30天内有联系记录或产品记录）
            const activeCustomers = customers.filter(customer => {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                // 检查产品记录
                if (customer.products) {
                    for (const product of customer.products) {
                        if (new Date(product.createdAt) >= thirtyDaysAgo) {
                            return true;
                        }
                    }
                }
                
                // 检查联系记录
                if (customer.contacts) {
                    for (const contact of customer.contacts) {
                        if (new Date(contact.date) >= thirtyDaysAgo) {
                            return true;
                        }
                    }
                }
                
                return false;
            });
            
            document.getElementById('stat-active-customers').textContent = activeCustomers.length;
            
            // 计算营养品客户数
            const nutritionCustomers = customers.filter(customer => 
                customer.products && customer.products.some(product => product.type === 'nutrition')
            ).length;
            document.getElementById('stat-nutrition-customers').textContent = nutritionCustomers;
            
            // 计算待回访客户数
            const followUpCustomers = customers.filter(customer => 
                customer.contacts && customer.contacts.some(contact => 
                    contact.result === '需要回访' && (!contact.nextContactDate || new Date(contact.nextContactDate) <= new Date())
                )
            ).length;
            document.getElementById('stat-follow-up-customers').textContent = followUpCustomers;
            
            // 创建客户状态分布图表
            createStatusChart();
            
            // 创建产品类型分布图表
            createProductChart();
            
            // 初始化时间段按钮事件
            initPeriodButtons();
            
            // 计算并显示销售统计数据
            calculateSalesStatistics();
            
            // 创建客户销售明细
            createCustomerSalesDetail();
            
            showModal('statistics-modal');
        }

        // 创建客户状态分布图表
        function createStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // 统计客户状态
            const statusCounts = {};
            customers.forEach(customer => {
                statusCounts[customer.status] = (statusCounts[customer.status] || 0) + 1;
            });
            
            // 销毁现有图表
            if (window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }
            
            window.statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // 当前选择的时间段，默认为今日
        let currentPeriod = 'today';
        
        // 计算销售统计数据
        function calculateSalesStatistics() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
            const yearStart = new Date(now.getFullYear(), 0, 1);
            
            let todaySales = 0;
            let weekSales = 0;
            let monthSales = 0;
            let quarterSales = 0;
            let yearSales = 0;
            
            let milkToday = 0, milkWeek = 0, milkMonth = 0, milkQuarter = 0, milkYear = 0;
            let diaperToday = 0, diaperWeek = 0, diaperMonth = 0, diaperQuarter = 0, diaperYear = 0;
            let nutritionToday = 0, nutritionWeek = 0, nutritionMonth = 0, nutritionQuarter = 0, nutritionYear = 0;
            
            customers.forEach(customer => {
                if (customer.products) {
                    customer.products.forEach(product => {
                        const productDate = new Date(product.date);
                        const productSales = product.totalPrice || 0;
                        
                        // 按时间统计总额
                        if (productDate >= today) todaySales += productSales;
                        if (productDate >= weekStart) weekSales += productSales;
                        if (productDate >= monthStart) monthSales += productSales;
                        if (productDate >= quarterStart) quarterSales += productSales;
                        if (productDate >= yearStart) yearSales += productSales;
                        
                        // 按产品类型和时间统计
                        if (product.type === 'milk') {
                            if (productDate >= today) milkToday += productSales;
                            if (productDate >= weekStart) milkWeek += productSales;
                            if (productDate >= monthStart) milkMonth += productSales;
                            if (productDate >= quarterStart) milkQuarter += productSales;
                            if (productDate >= yearStart) milkYear += productSales;
                        } else if (product.type === 'diaper') {
                            if (productDate >= today) diaperToday += productSales;
                            if (productDate >= weekStart) diaperWeek += productSales;
                            if (productDate >= monthStart) diaperMonth += productSales;
                            if (productDate >= quarterStart) diaperQuarter += productSales;
                            if (productDate >= yearStart) diaperYear += productSales;
                        } else if (product.type === 'nutrition') {
                            if (productDate >= today) nutritionToday += productSales;
                            if (productDate >= weekStart) nutritionWeek += productSales;
                            if (productDate >= monthStart) nutritionMonth += productSales;
                            if (productDate >= quarterStart) nutritionQuarter += productSales;
                            if (productDate >= yearStart) nutritionYear += productSales;
                        }
                    });
                }
            });
            
            // 更新销售统计显示
            document.getElementById('sales-today').textContent = todaySales.toFixed(2);
            document.getElementById('sales-week').textContent = weekSales.toFixed(2);
            document.getElementById('sales-month').textContent = monthSales.toFixed(2);
            document.getElementById('sales-quarter').textContent = quarterSales.toFixed(2);
            document.getElementById('sales-year').textContent = yearSales.toFixed(2);
            
            // 创建销售统计图表
            createSalesChart(todaySales, weekSales, monthSales, quarterSales, yearSales);
            
            // 根据当前选择的时间段更新产品类型销售统计
            updatePeriodStatistics(currentPeriod, {
                today: { total: todaySales, milk: milkToday, diaper: diaperToday, nutrition: nutritionToday },
                week: { total: weekSales, milk: milkWeek, diaper: diaperWeek, nutrition: nutritionWeek },
                month: { total: monthSales, milk: milkMonth, diaper: diaperMonth, nutrition: nutritionMonth },
                quarter: { total: quarterSales, milk: milkQuarter, diaper: diaperQuarter, nutrition: nutritionQuarter },
                year: { total: yearSales, milk: milkYear, diaper: diaperYear, nutrition: nutritionYear }
            });
        }
        
        // 更新当前时间段的销售统计
        function updatePeriodStatistics(period, data) {
            const periodData = data[period];
            const total = periodData.total;
            
            // 更新当前时间段总销售额
            document.getElementById('current-period-sales').textContent = total.toFixed(2) + ' 元';
            
            // 计算占比
            const milkPercentage = total > 0 ? (periodData.milk / total * 100).toFixed(2) : 0;
            const diaperPercentage = total > 0 ? (periodData.diaper / total * 100).toFixed(2) : 0;
            const nutritionPercentage = total > 0 ? (periodData.nutrition / total * 100).toFixed(2) : 0;
            
            // 更新产品类型销售统计
            document.getElementById('sales-milk').textContent = periodData.milk.toFixed(2);
            document.getElementById('sales-milk-percentage').textContent = milkPercentage + '%';
            document.getElementById('sales-diaper').textContent = periodData.diaper.toFixed(2);
            document.getElementById('sales-diaper-percentage').textContent = diaperPercentage + '%';
            document.getElementById('sales-nutrition').textContent = periodData.nutrition.toFixed(2);
            document.getElementById('sales-nutrition-percentage').textContent = nutritionPercentage + '%';
            
            // 更新产品销售占比图表
            createProductSalesChart(periodData.milk, periodData.diaper, periodData.nutrition);
        }
        
        // 初始化时间段选择按钮事件
        function initPeriodButtons() {
            const buttons = [
                { id: 'btn-today', period: 'today' },
                { id: 'btn-week', period: 'week' },
                { id: 'btn-month', period: 'month' },
                { id: 'btn-quarter', period: 'quarter' },
                { id: 'btn-year', period: 'year' }
            ];
            
            buttons.forEach(btnInfo => {
                const button = document.getElementById(btnInfo.id);
                if (button) {
                    button.addEventListener('click', function() {
                        // 更新当前选中的时间段
                        currentPeriod = btnInfo.period;
                        
                        // 更新按钮样式
                        document.querySelectorAll('.flex-wrap.gap-2 button').forEach(btn => {
                            btn.classList.remove('ring-2', 'ring-offset-2');
                        });
                        button.classList.add('ring-2', 'ring-offset-2');
                        
                        // 重新计算并显示统计数据
                        calculateSalesStatistics();
                    });
                }
            });
        }
        
        // 创建销售时间统计图表
        function createSalesChart(today, week, month, quarter, year) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            if (window.salesChartInstance) {
                window.salesChartInstance.destroy();
            }
            
            window.salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['今日', '本周', '本月', '本季度', '本年'],
                    datasets: [{
                        label: '销售额(元)',
                        data: [today, week, month, quarter, year],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                        ],
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 创建产品销售统计图表
        function createProductSalesChart(milk, diaper, nutrition) {
            const ctx = document.getElementById('productSalesChart').getContext('2d');
            
            if (window.productSalesChartInstance) {
                window.productSalesChartInstance.destroy();
            }
            
            window.productSalesChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['奶粉', '尿不湿', '营养品'],
                    datasets: [{
                        data: [milk, diaper, nutrition],
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                    return `${label}: ${value.toFixed(2)}元 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 创建客户销售明细
        function createCustomerSalesDetail() {
            const detailContainer = document.getElementById('customer-sales-detail');
            let detailHTML = '';
            
            // 计算每个客户的销售数据
            const customerSales = [];
            customers.forEach(customer => {
                let customerMilkSales = 0;
                let customerDiaperSales = 0;
                let customerNutritionSales = 0;
                let customerTotalSales = 0;
                
                if (customer.products) {
                    customer.products.forEach(product => {
                        const sales = product.totalPrice || 0;
                        customerTotalSales += sales;
                        
                        if (product.type === 'milk') customerMilkSales += sales;
                        else if (product.type === 'diaper') customerDiaperSales += sales;
                        else if (product.type === 'nutrition') customerNutritionSales += sales;
                    });
                }
                
                if (customerTotalSales > 0) {
                    customerSales.push({
                        name: customer.name,
                        milk: customerMilkSales,
                        diaper: customerDiaperSales,
                        nutrition: customerNutritionSales,
                        total: customerTotalSales
                    });
                }
            });
            
            // 按总销售额排序
            customerSales.sort((a, b) => b.total - a.total);
            
            if (customerSales.length === 0) {
                detailHTML = '<p class="text-gray-500 text-center py-4">暂无销售记录</p>';
            } else {
                detailHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">客户名称</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">奶粉销售额(元)</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">尿不湿销售额(元)</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">营养品销售额(元)</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">总销售额(元)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                `;
                
                customerSales.forEach(customer => {
                    detailHTML += `
                        <tr>
                            <td class="px-4 py-3 text-sm text-gray-900">${customer.name}</td>
                            <td class="px-4 py-3 text-right text-sm text-gray-900">${customer.milk.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right text-sm text-gray-900">${customer.diaper.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right text-sm text-gray-900">${customer.nutrition.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right text-sm font-medium text-gray-900">${customer.total.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                detailHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            detailContainer.innerHTML = detailHTML;
        }
        
        // 创建产品类型分布图表
        function createProductChart() {
            const ctx = document.getElementById('productChart').getContext('2d');
            
            // 统计产品类型
            const productCounts = {
                '奶粉': 0,
                '尿不湿': 0,
                '营养品': 0
            };
            
            customers.forEach(customer => {
                if (customer.products) {
                    customer.products.forEach(product => {
                        if (product.type === 'milk') {
                            productCounts['奶粉']++;
                        } else if (product.type === 'diaper') {
                            productCounts['尿不湿']++;
                        } else if (product.type === 'nutrition') {
                            productCounts['营养品']++;
                        }
                    });
                }
            });
            
            // 销毁现有图表
            if (window.productChartInstance) {
                window.productChartInstance.destroy();
            }
            
            window.productChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(productCounts),
                    datasets: [{
                        label: '产品数量',
                        data: Object.values(productCounts),
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B'
                        ],
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // 显示设置模态框
        function showSettings() {
            try {
                // 确保settings对象存在并有必要的属性
                if (!settings || typeof settings !== 'object') {
                    settings = { reminderDays: 7, defaultOwner: '' };
                    console.warn('设置对象不存在，使用默认值');
                }
                
                // 修复可能的无效值
                settings.reminderDays = parseInt(settings.reminderDays) || 7;
                settings.defaultOwner = settings.defaultOwner || '';
                
                // 确保DOM元素存在
                const reminderDaysInput = document.getElementById('reminder-days');
                const defaultOwnerInput = document.getElementById('default-owner');
                
                if (reminderDaysInput) {
                    reminderDaysInput.value = settings.reminderDays;
                } else {
                    console.error('未找到reminder-days元素');
                }
                
                if (defaultOwnerInput) {
                    defaultOwnerInput.value = settings.defaultOwner;
                } else {
                    console.error('未找到default-owner元素');
                }
                
                console.log('打开设置模态框，当前设置:', settings);
                showModal('settings-modal');
            } catch (error) {
                console.error('打开设置模态框失败:', error);
                showNotification('打开设置失败，请刷新页面重试！', 'error');
            }
        }
        
        // 测试函数：检查设置保存和加载
        function testSettings() {
            console.log('=== 测试设置功能 ===');
            
            // 1. 显示当前设置
            console.log('当前设置:', settings);
            
            // 2. 保存一个测试设置
            const testSettings = {
                reminderDays: 10,
                defaultOwner: '测试用户'
            };
            
            localStorage.setItem('motherBabySettings', JSON.stringify(testSettings));
            console.log('已保存测试设置:', testSettings);
            
            // 3. 重新加载设置
            loadData();
            console.log('重新加载后的设置:', settings);
            
            // 4. 验证设置是否正确加载
            if (settings.reminderDays === 10 && settings.defaultOwner === '测试用户') {
                console.log('✅ 设置保存和加载测试成功！');
                showNotification('设置功能测试成功！', 'success');
            } else {
                console.log('❌ 设置保存和加载测试失败！');
                showNotification('设置功能测试失败，请检查本地存储权限！', 'error');
            }
            
            return settings;
        }

        // 保存设置
        function saveSettings(event) {
            event.preventDefault();
            
            // 获取表单值
            const reminderDays = parseInt(document.getElementById('reminder-days').value) || 7;
            const defaultOwner = document.getElementById('default-owner').value;
            
            // 验证输入
            if (reminderDays < 1 || reminderDays > 30) {
                showNotification('提醒天数必须在1-30之间！', 'error');
                return;
            }
            
            // 更新设置对象
            settings.reminderDays = reminderDays;
            settings.defaultOwner = defaultOwner;
            
            // 调试信息
            console.log('保存设置:', settings);
            
            // 保存到本地存储
            saveData();
            
            // 验证保存是否成功
            const savedSettings = localStorage.getItem('motherBabySettings');
            if (savedSettings) {
                const parsedSettings = JSON.parse(savedSettings);
                console.log('保存后设置:', parsedSettings);
            }
            
            closeModal('settings-modal');
            updateDashboard();
            updateTodayReminders();
            
            // 显示成功消息
            showNotification('设置保存成功！', 'success');
        }

        // 显示数据管理模态框
        function showDataManagement() {
            showModal('data-management-modal');
        }

        // 导出数据
        function exportData() {
            const data = {
                customers: customers,
                storageRecords: storageRecords,
                settings: settings,
                completedReminders: completedReminders,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `母婴客户数据_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            // 显示成功消息
            showNotification('数据导出成功！', 'success');
        }

        // 导入数据（覆盖）
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('确定要导入数据吗？此操作将覆盖现有数据！')) {
                        if (data.customers) customers = data.customers;
                        if (data.storageRecords) storageRecords = data.storageRecords;
                        if (data.settings) settings = data.settings;
                        if (data.completedReminders) completedReminders = data.completedReminders;
                        
                        saveData();
                        updateDashboard();
                        updateCustomerList();
                        updateTodayReminders();
                        updateDueDateList();
                        updateProductUsageList();
                        updateStorageManagementList();
                        updateOwnerFilter();
                        
                        // 重置文件选择
                        document.getElementById('import-file').value = '';
                        document.getElementById('file-name').textContent = '未选择文件';
                        
                        // 显示成功消息
                        showNotification('数据导入成功！', 'success');
                    }
                } catch (error) {
                    showNotification('数据导入失败，请检查文件格式！', 'error');
                }
            };
            reader.readAsText(file);
            
            // 更新文件名显示
            document.getElementById('file-name').textContent = file.name;
        }

        // Bag导入数据（合并）
        function bagImportData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('确定要使用Bag导入数据吗？新数据将与现有数据合并，不会覆盖！')) {
                        let importedCount = 0;
                        
                        // 合并客户数据
                        if (data.customers && Array.isArray(data.customers)) {
                            data.customers.forEach(newCustomer => {
                                // 检查客户是否已存在（通过ID）
                                const existingCustomer = customers.find(c => c.id === newCustomer.id);
                                if (!existingCustomer) {
                                    // 如果客户不存在，直接添加
                                    customers.push(newCustomer);
                                    importedCount++;
                                } else {
                                    // 如果客户已存在，可以选择更新或跳过
                                    // 这里选择跳过，保持现有数据
                                    console.log(`客户 ${newCustomer.name} (ID: ${newCustomer.id}) 已存在，跳过导入`);
                                }
                            });
                        }
                        
                        // 合并寄存记录
                        if (data.storageRecords && Array.isArray(data.storageRecords)) {
                            data.storageRecords.forEach(newRecord => {
                                const existingRecord = storageRecords.find(r => r.id === newRecord.id);
                                if (!existingRecord) {
                                    storageRecords.push(newRecord);
                                }
                            });
                        }
                        
                        // 合并设置（可选）
                        if (data.settings) {
                            // 这里选择不覆盖现有设置，只添加新的设置项
                            settings = { ...settings, ...data.settings };
                        }
                        
                        // 合并已完成提醒
                        if (data.completedReminders && Array.isArray(data.completedReminders)) {
                            completedReminders = [...new Set([...completedReminders, ...data.completedReminders])];
                        }
                        
                        saveData();
                        updateDashboard();
                        updateCustomerList();
                        updateTodayReminders();
                        updateDueDateList();
                        updateProductUsageList();
                        updateStorageManagementList();
                        updateOwnerFilter();
                        
                        // 重置文件选择
                        document.getElementById('bag-import-file').value = '';
                        document.getElementById('bag-file-name').textContent = '未选择文件';
                        
                        // 显示成功消息
                        showNotification(`Bag导入成功！共导入 ${importedCount} 个新客户数据！`, 'success');
                    }
                } catch (error) {
                    console.error('Bag导入失败:', error);
                    showNotification('Bag导入失败，请检查文件格式！', 'error');
                }
            };
            reader.readAsText(file);
            
            // 更新文件名显示
            document.getElementById('bag-file-name').textContent = file.name;
        }

        // 确认清空数据
        function confirmClearData() {
            if (confirm('确定要清空所有数据吗？此操作将删除所有客户信息，且无法恢复！')) {
                customers = [];
                storageRecords = [];
                completedReminders = [];
                
                saveData();
                updateDashboard();
                updateCustomerList();
                updateTodayReminders();
                updateDueDateList();
                updateProductUsageList();
                updateStorageManagementList();
                updateOwnerFilter();
                
                // 显示成功消息
                showNotification('所有数据已清空！', 'success');
            }
        }

        // 显示合并客户模态框
        function showMergeCustomers() {
            const duplicateGroups = findDuplicateCustomers();
            const list = document.getElementById('duplicate-customers-list');
            
            if (duplicateGroups.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">未发现重复客户</p>';
            } else {
                list.innerHTML = duplicateGroups.map((group, index) => `
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">重复客户组 ${index + 1}</h4>
                        <div class="space-y-3">
                            ${group.map((customer, customerIndex) => `
                                <div class="flex items-center justify-between p-3 border border-gray-100 rounded-lg ${customerIndex === 0 ? 'bg-blue-50 border-blue-200' : ''}">
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" name="merge-group-${index}" value="${customer.id}" ${customerIndex === 0 ? 'checked' : ''} class="merge-primary">
                                        <div>
                                            <p class="font-medium">${customer.name}</p>
                                            <p class="text-sm text-gray-600">${customer.phone} | ${customer.owner}</p>
                                            <p class="text-xs text-gray-500">宝宝: ${customer.babies ? customer.babies.length : 0}个 | 产品: ${customer.products ? customer.products.length : 0}个</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="mergeCustomerGroup(${index})" class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fa fa-merge mr-2"></i>合并选中客户
                        </button>
                    </div>
                `).join('');
            }
            
            showModal('merge-customers-modal');
        }

        // 查找重复客户
        function findDuplicateCustomers() {
            const phoneMap = {};
            
            // 按电话号码分组
            customers.forEach(customer => {
                if (customer.phone) {
                    const normalizedPhone = customer.phone.replace(/\D/g, '');
                    if (normalizedPhone) {
                        if (!phoneMap[normalizedPhone]) {
                            phoneMap[normalizedPhone] = [];
                        }
                        phoneMap[normalizedPhone].push(customer);
                    }
                }
            });
            
            // 过滤出重复的组
            return Object.values(phoneMap).filter(group => group.length > 1);
        }

        // 合并客户组
        function mergeCustomerGroup(groupIndex) {
            const duplicateGroups = findDuplicateCustomers();
            const group = duplicateGroups[groupIndex];
            
            if (!group) return;
            
            // 获取选中的主客户ID
            const primaryId = parseInt(document.querySelector(`input[name="merge-group-${groupIndex}"]:checked`).value);
            const primaryCustomer = customers.find(c => c.id === primaryId);
            
            if (!primaryCustomer) return;
            
            // 合并其他客户的数据到主客户
            group.forEach(customer => {
                if (customer.id !== primaryId) {
                    // 合并宝宝信息
                    if (customer.babies) {
                        if (!primaryCustomer.babies) {
                            primaryCustomer.babies = [];
                        }
                        primaryCustomer.babies.push(...customer.babies);
                    }
                    
                    // 合并产品记录
                    if (customer.products) {
                        if (!primaryCustomer.products) {
                            primaryCustomer.products = [];
                        }
                        primaryCustomer.products.push(...customer.products);
                    }
                    
                    // 合并联系记录
                    if (customer.contacts) {
                        if (!primaryCustomer.contacts) {
                            primaryCustomer.contacts = [];
                        }
                        primaryCustomer.contacts.push(...customer.contacts);
                    }
                    
                    // 合并寄存记录
                    storageRecords.forEach(record => {
                        if (record.customerId === customer.id) {
                            record.customerId = primaryCustomer.id;
                            record.customerName = primaryCustomer.name;
                        }
                    });
                    
                    // 删除被合并的客户
                    customers = customers.filter(c => c.id !== customer.id);
                }
            });
            
            primaryCustomer.updatedAt = new Date().toISOString();
            saveData();
            
            // 刷新页面数据
            updateDashboard();
            updateCustomerList();
            updateStorageManagementList();
            updateOwnerFilter();
            
            // 重新显示合并客户模态框
            showMergeCustomers();
            
            // 显示成功消息
            showNotification('客户合并成功！', 'success');
        }

        // 显示寄存管理模态框
        function showStorageManagement() {
            updateStorageManagementList();
            showModal('storage-management-modal');
        }

        // 更新寄存管理列表
        function updateStorageManagementList() {
            const list = document.getElementById('storage-records-list');
            const searchTerm = document.getElementById('search-storage')?.value?.toLowerCase() || '';
            
            let filteredRecords = storageRecords;
            
            // 搜索过滤
            if (searchTerm) {
                filteredRecords = storageRecords.filter(record => 
                    record.customerName.toLowerCase().includes(searchTerm) ||
                    record.productName.toLowerCase().includes(searchTerm) ||
                    record.brand.toLowerCase().includes(searchTerm)
                );
            }
            
            // 按寄存日期排序（最新的在前）
            filteredRecords.sort((a, b) => new Date(b.storageDate) - new Date(a.storageDate));
            
            if (filteredRecords.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">暂无寄存记录</p>';
                return;
            }
            
            list.innerHTML = filteredRecords.map(record => {
                const statusClass = record.remainingQuantity === 0 ? 'bg-gray-100 text-gray-600' : record.remainingQuantity <= 2 ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800';
                const statusText = record.remainingQuantity === 0 ? '已取完' : record.remainingQuantity <= 2 ? '即将取完' : '寄存中';
                
                return `
                    <div class="bg-white rounded-lg p-6 border border-gray-200 hover:shadow-lg transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${record.customerName}</h3>
                                <p class="text-sm text-gray-600">${record.productName} - ${record.brand || '未填写'}</p>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600">寄存数量</p>
                                <p class="font-medium">${record.quantity}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">剩余数量</p>
                                <p class="font-medium ${record.remainingQuantity === 0 ? 'text-gray-500' : record.remainingQuantity <= 2 ? 'text-orange-600' : 'text-green-600'}">${record.remainingQuantity}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">已取数量</p>
                                <p class="font-medium">${record.quantity - record.remainingQuantity}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">取货次数</p>
                                <p class="font-medium">${record.pickups ? record.pickups.length : 0}次</p>
                            </div>
                        </div>
                        ${record.expectedPickupDates && record.expectedPickupDates.length > 0 ? `
                        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm font-semibold text-blue-800 mb-2">预计取货时间</p>
                            <div class="flex flex-wrap gap-2">
                                ${record.expectedPickupDates.map(date => `
                                    <span class="px-3 py-1 bg-white border border-blue-300 rounded-full text-sm text-blue-700">
                                        ${formatDate(date)}
                                    </span>
                                `).join('')}
                            </div>
                        </div>` : ''}
                        
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600">寄存日期</p>
                                <p class="font-medium">${formatDate(record.storageDate)}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="showCustomerDetail(${record.customerId})" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    <i class="fa fa-info-circle mr-1"></i>客户详情
                                </button>
                                ${record.remainingQuantity > 0 ? `
                                    <button onclick="showPickupModal(${record.id})" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                                        <i class="fa fa-shopping-cart mr-1"></i>取货登记
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 搜索寄存记录
        function searchStorage() {
            updateStorageManagementList();
        }
        
        // 获取产品类型的辅助函数
        function getProductType(productName, brand) {
            // 确定产品类型（根据产品名称判断）
            const milkKeywords = ['奶粉', '段', '卓睿', '飞鹤', '星飞帆', '美赞臣', '惠氏', '雅培', '爱他美', '诺优能'];
            const diaperKeywords = ['尿不湿', '纸尿裤', '尿片', '拉拉裤', '纸尿片', '帮宝适', '花王', '好奇', '尤妮佳'];
            const nutritionKeywords = ['营养品', '维生素', '钙片', 'DHA', '鱼肝油', '乳铁蛋白'];
            
            const productFullName = ((productName || '') + (brand || '')).toLowerCase();
            
            if (milkKeywords.some(keyword => productFullName.includes(keyword))) {
                return 'milk';
            } else if (diaperKeywords.some(keyword => productFullName.includes(keyword))) {
                return 'diaper';
            } else if (nutritionKeywords.some(keyword => productFullName.includes(keyword))) {
                return 'nutrition';
            }
            return 'other';
        }
        
        // 为所有寄存记录初始化产品类型
        function initializeProductTypes() {
            storageRecords.forEach(record => {
                if (!record.productType) {
                    record.productType = getProductType(record.productName, record.brand);
                }
            });
            saveData();
        }
        
        // 预计取货时间功能已删除

        // 显示添加寄存模态框
        function showAddStorageModal() {
            document.getElementById('add-storage-form').reset();
            document.getElementById('selected-customer-info').textContent = '请选择客户';
            
            // 客户搜索功能
            const searchInput = document.getElementById('storage-customer-search');
            searchInput.addEventListener('input', searchCustomersForStorage);
            
            showModal('add-storage-modal');
        }

        // 搜索客户（用于寄存）
        function searchCustomersForStorage() {
            const searchTerm = document.getElementById('storage-customer-search').value.toLowerCase();
            const resultsContainer = document.getElementById('customer-search-results');
            
            if (!searchTerm) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const matchedCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.phone.toLowerCase().includes(searchTerm)
            );
            
            if (matchedCustomers.length === 0) {
                resultsContainer.innerHTML = '<p class="p-2 text-gray-500">未找到匹配的客户</p>';
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            resultsContainer.innerHTML = matchedCustomers.map(customer => `
                <div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="selectCustomerForStorage(${customer.id}, '${customer.name}')">
                    <p class="font-medium">${customer.name}</p>
                    <p class="text-sm text-gray-600">${customer.phone} | ${customer.owner}</p>
                </div>
            `).join('');
            
            resultsContainer.classList.remove('hidden');
        }

        // 选择客户（用于寄存）
        function selectCustomerForStorage(customerId, customerName) {
            document.getElementById('storage-customer-select').value = customerId;
            document.getElementById('selected-customer-info').textContent = `已选择：${customerName}`;
            document.getElementById('customer-search-results').classList.add('hidden');
            document.getElementById('storage-customer-search').value = '';
        }

        // 保存寄存记录
        function saveStorageRecord(event) {
            event.preventDefault();
            
            const customerId = parseInt(document.getElementById('storage-customer-select').value);
            const productName = document.getElementById('storage-product-name').value;
            const brand = document.getElementById('storage-brand').value;
            const quantity = parseInt(document.getElementById('storage-quantity').value);
            const storageDate = document.getElementById('storage-date').value;
            const note = document.getElementById('storage-note').value;
            
            if (!customerId || !productName || !quantity || !storageDate) {
                showNotification('请填写完整的寄存信息！', 'warning');
                return;
            }
            
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('客户不存在！', 'error');
                return;
            }
            
            // 确定产品类型（根据产品名称判断）
            let productType = 'other';
            const milkKeywords = ['奶粉', '段', '卓睿', '飞鹤', '星飞帆'];
            const diaperKeywords = ['尿不湿', '纸尿裤', '尿片'];
            const nutritionKeywords = ['营养品', '维生素', '钙片', 'DHA'];
            
            const productFullName = (productName + brand).toLowerCase();
            
            if (milkKeywords.some(keyword => productFullName.includes(keyword))) {
                productType = 'milk';
            } else if (diaperKeywords.some(keyword => productFullName.includes(keyword))) {
                productType = 'diaper';
            } else if (nutritionKeywords.some(keyword => productFullName.includes(keyword))) {
                productType = 'nutrition';
            }
            
            const expectedDays = parseInt(document.getElementById('storage-expected-days').value) || 0;
            
            const storageRecord = {
                id: Date.now(),
                customerId: customerId,
                customerName: customer.name,
                productName: productName,
                brand: brand,
                productType: productType,
                quantity: quantity,
                remainingQuantity: quantity,
                storageDate: storageDate,
                note: note,
                expectedDays: expectedDays,
                pickups: []
            };
            
            storageRecords.push(storageRecord);
            saveData();
            closeModal('add-storage-modal');
            updateStorageManagementList();
            
            // 显示成功消息
            showNotification('寄存记录添加成功！', 'success');
        }

        // 显示取货模态框
        function showPickupModal(storageId) {
            document.getElementById('pickup-form').reset();
            document.getElementById('pickup-storage-id').value = storageId;
            document.getElementById('selected-storage-info').textContent = '请选择寄存记录';
            document.getElementById('storage-info').textContent = '';
            
            // 设置默认日期为今天
            document.getElementById('pickup-date').value = new Date().toISOString().split('T')[0];
            
            // 如果指定了寄存ID，直接加载该记录
            if (storageId) {
                const record = storageRecords.find(r => r.id === storageId);
                if (record) {
                    selectStorageForPickup(record.id);
                }
            }
            
            // 寄存记录搜索功能
            const searchInput = document.getElementById('pickup-search-input');
            searchInput.addEventListener('input', searchStorageForPickup);
            
            showModal('pickup-modal');
        }

        // 搜索寄存记录（用于取货）
        function searchStorageForPickup() {
            const searchTerm = document.getElementById('pickup-search-input').value.toLowerCase();
            const resultsContainer = document.getElementById('pickup-search-results');
            
            if (!searchTerm) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const matchedRecords = storageRecords.filter(record => 
                record.customerName.toLowerCase().includes(searchTerm) ||
                record.productName.toLowerCase().includes(searchTerm) ||
                record.brand.toLowerCase().includes(searchTerm)
            ).filter(record => record.remainingQuantity > 0);
            
            if (matchedRecords.length === 0) {
                resultsContainer.innerHTML = '<p class="p-2 text-gray-500">未找到匹配的寄存记录或已取完</p>';
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            resultsContainer.innerHTML = matchedRecords.map(record => `
                <div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="selectStorageForPickup(${record.id})">
                    <p class="font-medium">${record.customerName} - ${record.productName}</p>
                    <p class="text-sm text-gray-600">${record.brand || '未填写'}</p>
                    <p class="text-xs text-gray-500">剩余：${record.remainingQuantity} | 寄存日期：${formatDate(record.storageDate)}</p>
                </div>
            `).join('');
            
            resultsContainer.classList.remove('hidden');
        }

        // 选择寄存记录（用于取货）
        function selectStorageForPickup(storageId) {
            const record = storageRecords.find(r => r.id === storageId);
            if (!record) return;
            
            document.getElementById('pickup-storage-id').value = storageId;
            document.getElementById('selected-storage-info').textContent = `已选择：${record.customerName} - ${record.productName}`;
            
            // 显示寄存信息
            document.getElementById('storage-info').innerHTML = `
                <p><strong>客户：</strong>${record.customerName}</p>
                <p><strong>产品：</strong>${record.productName} - ${record.brand || '未填写'}</p>
                <p><strong>寄存数量：</strong>${record.quantity}</p>
                <p><strong>剩余数量：</strong><span class="text-green-600 font-medium">${record.remainingQuantity}</span></p>
                <p><strong>寄存日期：</strong>${formatDate(record.storageDate)}</p>
                ${record.note ? `<p><strong>备注：</strong>${record.note}</p>` : ''}
            `;
            
            // 设置取货数量默认值为1
            document.getElementById('pickup-quantity').value = 1;
            validatePickupQuantity();
            
            document.getElementById('pickup-search-results').classList.add('hidden');
            document.getElementById('pickup-search-input').value = '';
        }

        // 验证取货数量
        function validatePickupQuantity() {
            const storageId = parseInt(document.getElementById('pickup-storage-id').value);
            const quantity = parseInt(document.getElementById('pickup-quantity').value);
            const warning = document.getElementById('quantity-warning');
            
            if (!storageId || isNaN(quantity)) {
                warning.classList.add('hidden');
                return false;
            }
            
            const record = storageRecords.find(r => r.id === storageId);
            if (!record) {
                warning.classList.add('hidden');
                return false;
            }
            
            if (quantity > record.remainingQuantity) {
                warning.classList.remove('hidden');
                return false;
            }
            
            warning.classList.add('hidden');
            return true;
        }

        // 保存取货记录
        function savePickupRecord(event) {
            event.preventDefault();
            
            const storageId = parseInt(document.getElementById('pickup-storage-id').value);
            const quantity = parseInt(document.getElementById('pickup-quantity').value);
            const pickupDate = document.getElementById('pickup-date').value;
            const note = document.getElementById('pickup-note').value;
            
            if (!storageId || isNaN(quantity) || !pickupDate) {
                showNotification('请填写完整的取货信息！', 'warning');
                return;
            }
            
            if (!validatePickupQuantity()) {
                showNotification('取货数量不能大于剩余数量！', 'error');
                return;
            }
            
            const record = storageRecords.find(r => r.id === storageId);
            if (!record) {
                showNotification('寄存记录不存在！', 'error');
                return;
            }
            
            // 创建取货记录
            const pickupRecord = {
                id: Date.now(),
                quantity: quantity,
                date: pickupDate,
                note: note
            };
            
            // 更新寄存记录
            if (!record.pickups) {
                record.pickups = [];
            }
            record.pickups.push(pickupRecord);
            record.remainingQuantity -= quantity;
            
            // 更新预计取货时间
            if (record.remainingQuantity > 0) {
                // 使用当前取货数量计算下次取货时间
                calculateExpectedPickupDates(record, quantity);
            } else {
                // 如果剩余数量为0，清空预计取货时间
                record.expectedPickupDates = [];
            }
            
            saveData();
            closeModal('pickup-modal');
            updateStorageManagementList();
            
            // 刷新客户详情页面（如果打开）
            const detailModal = document.getElementById('customer-detail-modal');
            if (!detailModal.classList.contains('hidden')) {
                const customerId = detailModal.dataset.customerId;
                if (customerId) {
                    showCustomerDetail(customerId);
                }
            }
            
            // 显示成功消息
            showNotification('取货记录添加成功！', 'success');
        }

        // 显示帮助模态框
        function showHelp() {
            showModal('help-modal');
        }

        // 设置当前月份
        function setCurrentMonth() {
            const now = new Date();
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            document.getElementById('current-month').textContent = monthNames[now.getMonth()];
        }

        // 加载客户产品（用于添加产品时的客户选择）
        function loadCustomerProducts() {
            // 这里可以添加加载客户历史产品的逻辑
            // 目前不需要实现
        }

        // 过滤客户
        function filterCustomers() {
            const searchTerm = document.getElementById('search-customer').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const ownerFilter = document.getElementById('owner-filter').value;
            
            updateCustomerList();
        }

        // 获取过滤后的客户
        function getFilteredCustomers() {
            const searchTerm = document.getElementById('search-customer').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const ownerFilter = document.getElementById('owner-filter').value;
            
            return customers.filter(customer => {
                // 搜索过滤
                if (searchTerm && !(
                    customer.name.toLowerCase().includes(searchTerm) ||
                    customer.phone.toLowerCase().includes(searchTerm) ||
                    customer.wechat.toLowerCase().includes(searchTerm) ||
                    customer.identity.toLowerCase().includes(searchTerm)
                )) {
                    return false;
                }
                
                // 状态过滤
                if (statusFilter !== 'all' && customer.status !== statusFilter) {
                    return false;
                }
                
                // 归属人过滤
                if (ownerFilter !== 'all' && customer.owner !== ownerFilter) {
                    return false;
                }
                
                return true;
            }).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        }

        // 更新归属人过滤器
        function updateOwnerFilter() {
            const select = document.getElementById('owner-filter');
            const owners = [...new Set(customers.map(customer => customer.owner))].filter(owner => owner);
            
            // 保存当前选中的值
            const currentValue = select.value;
            
            // 清空并重新添加选项
            select.innerHTML = '<option value="all">所有归属人</option>';
            
            owners.forEach(owner => {
                const option = document.createElement('option');
                option.value = owner;
                option.textContent = owner;
                select.appendChild(option);
            });
            
            // 恢复选中的值
            if (currentValue && owners.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '未设置';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // 格式化月份
        function formatMonth(monthString) {
            if (!monthString) return '未设置';
            
            const date = new Date(monthString + '-01');
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' });
        }

        // 获取年龄
        function getAge(birthDateString) {
            if (!birthDateString) return '未设置';
            
            const birthDate = new Date(birthDateString);
            const today = new Date();
            
            let ageYears = today.getFullYear() - birthDate.getFullYear();
            let ageMonths = today.getMonth() - birthDate.getMonth();
            
            if (ageMonths < 0 || (ageMonths === 0 && today.getDate() < birthDate.getDate())) {
                ageYears--;
                ageMonths += 12;
            }
            
            if (ageYears > 0) {
                return `${ageYears}岁${ageMonths}个月`;
            } else {
                return `${ageMonths}个月`;
            }
        }

        // 自动计算价格函数
        function calculateMilkTotalPrice() {
            const price = parseFloat(document.getElementById('new-milk-price').value);
            const quantity = parseInt(document.getElementById('new-milk-purchase-quantity').value);
            
            if (price && quantity) {
                document.getElementById('new-milk-total-price').value = (price * quantity).toFixed(2);
            }
        }
        
        function calculateMilkPrice() {
            const totalPrice = parseFloat(document.getElementById('new-milk-total-price').value);
            const quantity = parseInt(document.getElementById('new-milk-purchase-quantity').value);
            
            if (totalPrice && quantity) {
                document.getElementById('new-milk-price').value = (totalPrice / quantity).toFixed(2);
            }
        }
        
        function calculateDiaperTotalPrice() {
            const price = parseFloat(document.getElementById('new-diaper-price').value);
            const quantity = parseInt(document.getElementById('new-diaper-purchase-quantity').value);
            
            if (price && quantity) {
                document.getElementById('new-diaper-total-price').value = (price * quantity).toFixed(2);
            }
        }
        
        function calculateDiaperPrice() {
            const totalPrice = parseFloat(document.getElementById('new-diaper-total-price').value);
            const quantity = parseInt(document.getElementById('new-diaper-purchase-quantity').value);
            
            if (totalPrice && quantity) {
                document.getElementById('new-diaper-price').value = (totalPrice / quantity).toFixed(2);
            }
        }
        
        function calculateNutritionTotalPrice() {
            const price = parseFloat(document.getElementById('new-nutrition-price').value);
            const quantity = parseInt(document.getElementById('new-nutrition-purchase-quantity').value);
            
            if (price && quantity) {
                document.getElementById('new-nutrition-total-price').value = (price * quantity).toFixed(2);
            }
        }
        
        function calculateNutritionPrice() {
            const totalPrice = parseFloat(document.getElementById('new-nutrition-total-price').value);
            const quantity = parseInt(document.getElementById('new-nutrition-purchase-quantity').value);
            
            if (totalPrice && quantity) {
                document.getElementById('new-nutrition-price').value = (totalPrice / quantity).toFixed(2);
            }
        }
        
        // 计算年龄天数
        function calculateAgeInDays(birthDateString) {
            if (!birthDateString) return 0;
            
            const birthDate = new Date(birthDateString);
            const today = new Date();
            const timeDiff = today - birthDate;
            return Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        }

        // 获取产品类型名称
        function getProductTypeName(type) {
            switch (type) {
                case 'milk': return '奶粉';
                case 'diaper': return '尿不湿';
                case 'nutrition': return '营养品';
                default: return type;
            }
        }

        // 获取状态标签样式
        function getStatusBadgeClass(status) {
            switch (status) {
                case '正常': return 'bg-green-100 text-green-800';
                case '孕妇': return 'bg-purple-100 text-purple-800';
                case '新客户': return 'bg-blue-100 text-blue-800';
                case 'VIP': return 'bg-yellow-100 text-yellow-800';
                case '暂停服务': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // 获取联系结果样式
        function getContactResultClass(result) {
            switch (result) {
                case '接通': return 'bg-green-100 text-green-800';
                case '未接通': return 'bg-red-100 text-red-800';
                case '需要回访': return 'bg-orange-100 text-orange-800';
                case '已购买': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fa ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-times-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    }"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 显示通知
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // 自动隐藏通知
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 点击其他区域关闭下拉菜单
        document.addEventListener('click', function(event) {
            const searchResults = document.querySelectorAll('#customer-search-results, #pickup-search-results');
            const searchInputs = document.querySelectorAll('#storage-customer-search, #pickup-search-input');
            
            searchResults.forEach((result, index) => {
                if (!result.contains(event.target) && !searchInputs[index].contains(event.target)) {
                    result.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
